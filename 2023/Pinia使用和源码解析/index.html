<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>Piniaä½¿ç”¨å’Œæºç è§£æ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="JavaScript,Vue">
    <div style="display:none;"><img src="/img/avatar.jpg"></div>
    <meta property="og:image" content="https://summxu.github.io/img/avatar.jpg">
    <meta name="description" content="åˆ›å»ºpiniaåŸºæœ¬ä½¿ç”¨ 123456789101112131415const pinia = createPinia()const app = createApp(App)app.use(pinia)app.mount(&apos;#app&apos;)//vue2 ä½¿ç”¨import &amp;#123; createPinia, PiniaVuePlugin &amp;#125; from &apos;pinia&apos;Vue.use(Pinia">
<meta name="keywords" content="JavaScript,Vue">
<meta property="og:type" content="article">
<meta property="og:title" content="Piniaä½¿ç”¨å’Œæºç è§£æ">
<meta property="og:url" content="https://summxu.github.io/2023/Piniaä½¿ç”¨å’Œæºç è§£æ/index.html">
<meta property="og:site_name" content="å°å…µæ—­æ—­çš„åšå®¢">
<meta property="og:description" content="åˆ›å»ºpiniaåŸºæœ¬ä½¿ç”¨ 123456789101112131415const pinia = createPinia()const app = createApp(App)app.use(pinia)app.mount(&apos;#app&apos;)//vue2 ä½¿ç”¨import &amp;#123; createPinia, PiniaVuePlugin &amp;#125; from &apos;pinia&apos;Vue.use(Pinia">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2023-11-28T09:16:56.452Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Piniaä½¿ç”¨å’Œæºç è§£æ">
<meta name="twitter:description" content="åˆ›å»ºpiniaåŸºæœ¬ä½¿ç”¨ 123456789101112131415const pinia = createPinia()const app = createApp(App)app.use(pinia)app.mount(&apos;#app&apos;)//vue2 ä½¿ç”¨import &amp;#123; createPinia, PiniaVuePlugin &amp;#125; from &apos;pinia&apos;Vue.use(Pinia">
    
        <link rel="alternate" type="application/atom+xml" title="å°å…µæ—­æ—­çš„åšå®¢" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu"  >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">summxu</h5>
          <a href="mailto:chenxu4012@foxmail.com" title="chenxu4012@foxmail.com" class="mail">chenxu4012@foxmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                ä¸»é¡µ
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-align-right"></i>
                æ—¶é—´çº¿
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags/JavaScript"  >
                <i class="icon icon-lg icon-star"></i>
                åˆ†ç±»æ ‡ç­¾
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about"  >
                <i class="icon icon-lg icon-grav"></i>
                è¿™æ˜¯æˆ‘
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/summxu" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://weibo.com/u/1938786603" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/atom.xml" target="_blank" >
                <i class="icon icon-lg icon-rss-square"></i>
                Rss
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Piniaä½¿ç”¨å’Œæºç è§£æ</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="è¾“å…¥æ„Ÿå…´è¶£çš„å…³é”®å­—">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Piniaä½¿ç”¨å’Œæºç è§£æ</h1>
        <h5 class="subtitle">
            
                <time datetime="2023-06-26T01:36:37.000Z" itemprop="datePublished" class="page-time">
  2023-06-26
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#åˆ›å»ºpinia"><span class="post-toc-number">1.</span> <span class="post-toc-text">åˆ›å»ºpinia</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#createPinia"><span class="post-toc-number">2.</span> <span class="post-toc-text">createPinia</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#è®¾ç½®ã€è·å–pinia"><span class="post-toc-number">3.</span> <span class="post-toc-text">è®¾ç½®ã€è·å–pinia</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#å…¼å®¹vue2"><span class="post-toc-number">4.</span> <span class="post-toc-text">å…¼å®¹vue2</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#åˆ›å»ºstore"><span class="post-toc-number">5.</span> <span class="post-toc-text">åˆ›å»ºstore</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#defineStore"><span class="post-toc-number">6.</span> <span class="post-toc-text">defineStore</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#createSetupStore"><span class="post-toc-number">7.</span> <span class="post-toc-text">createSetupStore</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#å“åº”å¼å¤„ç†store"><span class="post-toc-number">7.1.</span> <span class="post-toc-text">å“åº”å¼å¤„ç†store</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#å¤„ç†setupè¿”å›çš„å†…å®¹"><span class="post-toc-number">7.2.</span> <span class="post-toc-text">å¤„ç†setupè¿”å›çš„å†…å®¹</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#åŒæ­¥setupè¿”å›å†…å®¹å’Œpinia-state"><span class="post-toc-number">7.3.</span> <span class="post-toc-text">åŒæ­¥setupè¿”å›å†…å®¹å’Œpinia.state</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#å¤„ç†action"><span class="post-toc-number">7.4.</span> <span class="post-toc-text">å¤„ç†action</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#å¤„ç†storeåˆå¹¶setup"><span class="post-toc-number">7.5.</span> <span class="post-toc-text">å¤„ç†storeåˆå¹¶setup</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#createOptionsStore"><span class="post-toc-number">8.</span> <span class="post-toc-text">createOptionsStore</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#è®¢é˜…å‘å¸ƒ"><span class="post-toc-number">9.</span> <span class="post-toc-text">è®¢é˜…å‘å¸ƒ</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#å‘å¸ƒè®¢é˜…æ¨¡å¼"><span class="post-toc-number">10.</span> <span class="post-toc-text">å‘å¸ƒè®¢é˜…æ¨¡å¼</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#ç›‘å¬action"><span class="post-toc-number">11.</span> <span class="post-toc-text">ç›‘å¬action</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#é€šè¿‡-onActionæ·»åŠ è®¢é˜…"><span class="post-toc-number">11.1.</span> <span class="post-toc-text">é€šè¿‡$onActionæ·»åŠ è®¢é˜…</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#é€šè¿‡wrapActionè¿›è¡Œå‘å¸ƒ"><span class="post-toc-number">11.2.</span> <span class="post-toc-text">é€šè¿‡wrapActionè¿›è¡Œå‘å¸ƒ</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#ç›‘å¬ä¿®æ”¹state"><span class="post-toc-number">12.</span> <span class="post-toc-text">ç›‘å¬ä¿®æ”¹state</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ç›´æ¥ä¿®æ”¹state"><span class="post-toc-number">12.1.</span> <span class="post-toc-text">ç›´æ¥ä¿®æ”¹state</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#patchä¿®æ”¹"><span class="post-toc-number">12.2.</span> <span class="post-toc-text">$patchä¿®æ”¹</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#store-API"><span class="post-toc-number">13.</span> <span class="post-toc-text">store API</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#reset"><span class="post-toc-number">14.</span> <span class="post-toc-text">$reset</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#dispose"><span class="post-toc-number">15.</span> <span class="post-toc-text">$dispose</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#storeToRefsè§£æ„store"><span class="post-toc-number">16.</span> <span class="post-toc-text">storeToRefsè§£æ„store</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#mapç³»åˆ—è¾…åŠ©å‡½æ•°"><span class="post-toc-number">17.</span> <span class="post-toc-text">mapç³»åˆ—è¾…åŠ©å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#mapState"><span class="post-toc-number">18.</span> <span class="post-toc-text">mapState</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#mapGetters"><span class="post-toc-number">19.</span> <span class="post-toc-text">mapGetters</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#mapActions"><span class="post-toc-number">20.</span> <span class="post-toc-text">mapActions</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#å’ŒvuexåŒºåˆ«"><span class="post-toc-number">21.</span> <span class="post-toc-text">å’ŒvuexåŒºåˆ«</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#ä¸å†æœ‰åµŒå¥—ç»“æ„çš„æ¨¡å—"><span class="post-toc-number">22.</span> <span class="post-toc-text">ä¸å†æœ‰åµŒå¥—ç»“æ„çš„æ¨¡å—</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#åˆ›å»ºéå¸¸æ–¹ä¾¿ï¼Œå’Œå†™ä¸€ä¸ªhookå‡½æ•°ä¸€æ ·è½»æ¾"><span class="post-toc-number">23.</span> <span class="post-toc-text">åˆ›å»ºéå¸¸æ–¹ä¾¿ï¼Œå’Œå†™ä¸€ä¸ªhookå‡½æ•°ä¸€æ ·è½»æ¾</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#æ— éœ€mutation"><span class="post-toc-number">24.</span> <span class="post-toc-text">æ— éœ€mutation</span></a></li></ol>
        </nav>
    </aside>


<article id="post-2023/Piniaä½¿ç”¨å’Œæºç è§£æ"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Piniaä½¿ç”¨å’Œæºç è§£æ</h1>
        <div class="post-meta">
            <time class="post-time" title="2023-06-26 09:36:37" datetime="2023-06-26T01:36:37.000Z"  itemprop="datePublished">2023-06-26</time>

            


            
<span id="busuanzi_container_page_pv" title="æ–‡ç« æ€»é˜…è¯»é‡" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="åˆ›å»ºpinia"><a href="#åˆ›å»ºpinia" class="headerlink" title="åˆ›å»ºpinia"></a>åˆ›å»ºpinia</h2><p>åŸºæœ¬ä½¿ç”¨</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> pinia = createPinia()</span><br><span class="line"><span class="keyword">const</span> app = createApp(App)</span><br><span class="line"></span><br><span class="line">app.use(pinia)</span><br><span class="line">app.mount(<span class="string">'#app'</span>)</span><br><span class="line"><span class="comment">//vue2 ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">import</span> &#123; createPinia, PiniaVuePlugin &#125; <span class="keyword">from</span> <span class="string">'pinia'</span></span><br><span class="line"></span><br><span class="line">Vue.use(PiniaVuePlugin)</span><br><span class="line"><span class="keyword">const</span> pinia = createPinia()</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>, </span><br><span class="line">  pinia,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="createPinia"><a href="#createPinia" class="headerlink" title="createPinia"></a>createPinia</h2><ul>
<li>å°†piniaç»‘å®šåˆ°å®ä¾‹ä¸Š</li>
<li>åˆ›å»ºä¸€ä¸ªscopeç”¨æ¥ä¿å­˜ä¹‹ååˆ›å»ºçš„æ¯ä¸€ä¸ªstoreçš„stateï¼Œä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡pinia.state.value[storeId]ç›´æ¥è®¾ç½®state</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ceatePinia.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createPinia</span>(<span class="params"></span>): <span class="title">Pinia</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºä¸ªscope effctæ¥å•ç‹¬ç®¡ç†state</span></span><br><span class="line">  <span class="keyword">const</span> scope = effectScope(<span class="literal">true</span>)</span><br><span class="line">  <span class="comment">// é€šè¿‡pinia.state.value[storeId]ä¼šä¿å­˜ä¹‹ååˆ›å»ºçš„storeçš„state</span></span><br><span class="line">  <span class="keyword">const</span> state = scope.run&lt;Ref&lt;Record&lt;<span class="built_in">string</span>, StateTree&gt;&gt;&gt;<span class="function">(<span class="params">(<span class="params"></span>) =&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    ref&lt;Record&lt;<span class="built_in">string</span>, StateTree&gt;&gt;(<span class="params">&#123;&#125;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>)!</span></span><br><span class="line"><span class="function">  </span></span><br><span class="line"><span class="function">  // æ’ä»¶ç›¸å…³</span></span><br><span class="line"><span class="function">  <span class="params">let</span> _<span class="params">p</span>: <span class="params">Pinia</span>['_<span class="params">p</span>'] = []</span></span><br><span class="line"><span class="function">  // <span class="params">plugins</span> <span class="params">added</span> <span class="params">before</span> <span class="params">calling</span> <span class="params">app</span>.<span class="params">use</span>(<span class="params">pinia</span>)</span></span><br><span class="line"><span class="function">  <span class="params">let</span> <span class="params">toBeInstalled</span>: <span class="params">PiniaPlugin</span>[] = []</span></span><br><span class="line"><span class="function">  </span></span><br><span class="line"><span class="function">  // <span class="params">markRaw</span>æ ‡è®°<span class="params">pinia</span>ä¸å¯è¢«ä»£ç†,é¿å…å­˜åœ¨ç”¨æˆ·å°†å…¶å“åº”å¼åŒ–å½±å“æ€§èƒ½çš„æƒ…å†µ</span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">pinia</span>: <span class="params">Pinia</span> = <span class="params">markRaw</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    install(<span class="params">app: App</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="comment">// è®¾ç½®å½“å‰æ´»è·ƒçš„piniaï¼Œæ–¹ä¾¿å…¶ä»–åœ°æ–¹è·å–</span></span></span></span><br><span class="line"><span class="function"><span class="params">      setActivePinia(<span class="params">pinia</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">if</span> (<span class="params">!isVue2</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">        pinia._a = app</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="comment">// å†…éƒ¨é€šè¿‡injectè·å–pinia,å› ä¸ºpiniaSymbolæ²¡æœ‰å¯¼å‡ºï¼Œæ‰€ä»¥å¼€å‘è€…æ— æ³•é€šè¿‡injectè·å–pinia</span></span></span></span><br><span class="line"><span class="function"><span class="params">        app.provide(<span class="params">piniaSymbol, pinia</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="comment">// é€šè¿‡app.config.globalPropertieså°†piniaæŒ‚è½½åˆ°ç»„ä»¶å®ä¾‹ä¸Š</span></span></span></span><br><span class="line"><span class="function"><span class="params">        app.config.globalProperties.$pinia = pinia</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">if</span> (<span class="params">USE_DEVTOOLS</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">          registerPiniaDevtools(<span class="params">app, pinia</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">        &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">        toBeInstalled.forEach(<span class="params">(<span class="params">plugin</span>) =&gt; _p.push(<span class="params">plugin</span>)</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">        toBeInstalled = []</span></span></span><br><span class="line"><span class="function"><span class="params">      &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">// piniaæ’ä»¶ç›¸å…³ï¼Œæš‚ä¸åˆ†æ</span></span></span></span><br><span class="line"><span class="function"><span class="params">    use(<span class="params">plugin</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">if</span> (<span class="params">!<span class="keyword">this</span>._a &amp;&amp; !isVue2</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">        toBeInstalled.push(<span class="params">plugin</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">      &#125; <span class="keyword">else</span> &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">        _p.push(<span class="params">plugin</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">      &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">return</span> <span class="keyword">this</span></span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;,</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    _p,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">// it's actually undefined here</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">// @ts-expect-error</span></span></span></span><br><span class="line"><span class="function"><span class="params">    _a: <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    _e: scope,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">// æ¯ä¸ªåˆ›å»ºçš„storeéƒ½ä¼šæ”¾åœ¨è¿™ä¸ªMapé‡Œ</span></span></span></span><br><span class="line"><span class="function"><span class="params">    _s: <span class="keyword">new</span> Map&lt;<span class="built_in">string</span>, StoreGeneric&gt;(<span class="params"></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">    state,</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  //...</span></span><br><span class="line"><span class="function">  <span class="params">return</span> <span class="params">pinia</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="è®¾ç½®ã€è·å–pinia"><a href="#è®¾ç½®ã€è·å–pinia" class="headerlink" title="è®¾ç½®ã€è·å–pinia"></a>è®¾ç½®ã€è·å–pinia</h2><ul>
<li>piniaä¼šè¢«ä¿å­˜åˆ°ä¸€ä¸ªå…¨å±€å˜é‡ä¸Šï¼Œå†…éƒ¨å¯ä»¥é€šè¿‡setActivePiniaã€getActivePiniaå¿«é€Ÿè·å–åˆ°piniaï¼Œç„¶åä½¿ç”¨ä¸Šä¸€æ­¥æŒ‚åœ¨piniaä¸Šçš„å±æ€§æˆ–æ–¹æ³•</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//rootStore.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> activePinia: Pinia | <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> setActivePinia = <span class="function">(<span class="params">pinia: Pinia | <span class="literal">undefined</span></span>) =&gt;</span></span><br><span class="line">  (activePinia = pinia)</span><br><span class="line">  </span><br><span class="line"><span class="comment">// å¦‚æœåœ¨vueç»„ä»¶ä¸­ï¼Œé€šè¿‡injectè·å–ï¼ˆåœ¨createPiniaä¸­å¯¼å‡ºï¼‰ã€å¦åˆ™ç›´æ¥å–å…¨å±€å˜é‡ </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getActivePinia = <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">  (getCurrentInstance() &amp;&amp; inject(piniaSymbol)) || activePinia</span><br></pre></td></tr></table></figure>

<h2 id="å…¼å®¹vue2"><a href="#å…¼å®¹vue2" class="headerlink" title="å…¼å®¹vue2"></a>å…¼å®¹vue2</h2><ul>
<li>çœ‹è¿‡vuexçš„è¿™æ®µåº”è¯¥å¾ˆç†Ÿæ‚‰</li>
<li>é€šè¿‡Object.definePropertyä»¿é€ äº†ä¸ªProvideåŠŸèƒ½</li>
<li>é€šè¿‡mixinså°†piniaæ³¨å…¥åˆ°æ¯ä¸€ä¸ªç»„ä»¶ä¸­</li>
</ul>
<p>PiniaVuePlugin</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//vue2-plugin.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> PiniaVuePlugin: Plugin = <span class="function"><span class="keyword">function</span> (<span class="params">_Vue</span>) </span>&#123;</span><br><span class="line">  _Vue.mixin(&#123;</span><br><span class="line">    beforeCreate() &#123;</span><br><span class="line">      <span class="keyword">const</span> options = <span class="keyword">this</span>.$options</span><br><span class="line">      <span class="keyword">if</span> (options.pinia) &#123;</span><br><span class="line">      <span class="comment">// è·å–æ³¨å†Œåˆ°æ ¹ç»„ä»¶ä¸Šçš„pinia</span></span><br><span class="line">        <span class="keyword">const</span> pinia = options.pinia <span class="keyword">as</span> Pinia</span><br><span class="line">        <span class="comment">// é€šè¿‡Object.definePropertyå®ç°çš„hackç‰ˆprovidã€inject...</span></span><br><span class="line">        <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">as</span> <span class="built_in">any</span>)._provided) &#123;</span><br><span class="line">          <span class="keyword">const</span> provideCache = &#123;&#125;</span><br><span class="line">          <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>, <span class="string">'_provided'</span>, &#123;</span><br><span class="line">            <span class="keyword">get</span>: <span class="function"><span class="params">()</span> =&gt;</span> provideCache,</span><br><span class="line">            <span class="keyword">set</span>: <span class="function">(<span class="params">v</span>) =&gt;</span> <span class="built_in">Object</span>.assign(provideCache, v),</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        ;(<span class="keyword">this</span> <span class="keyword">as</span> <span class="built_in">any</span>)._provided[piniaSymbol <span class="keyword">as</span> <span class="built_in">any</span>] = pinia</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.$pinia) &#123;</span><br><span class="line">          <span class="keyword">this</span>.$pinia = pinia</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pinia._a = <span class="keyword">this</span> <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">        <span class="keyword">if</span> (IS_CLIENT) &#123;</span><br><span class="line">          <span class="comment">// this allows calling useStore() outside of a component setup after</span></span><br><span class="line">          <span class="comment">// installing pinia's plugin</span></span><br><span class="line">          setActivePinia(pinia)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (USE_DEVTOOLS) &#123;</span><br><span class="line">          registerPiniaDevtools(pinia._a, pinia)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.$pinia &amp;&amp; options.parent &amp;&amp; options.parent.$pinia) &#123;</span><br><span class="line">        <span class="keyword">this</span>.$pinia = options.parent.$pinia</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    destroyed() &#123;</span><br><span class="line">      <span class="keyword">delete</span> <span class="keyword">this</span>._pStores</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åˆ›å»ºstore"><a href="#åˆ›å»ºstore" class="headerlink" title="åˆ›å»ºstore"></a>åˆ›å»ºstore</h2><p>åˆ›å»ºstoreçš„ä¸‰ç§æ–¹å¼</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> useUserStore = defineStore(<span class="string">'counter'</span>, &#123;</span><br><span class="line">  state: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    count: <span class="number">0</span></span><br><span class="line">  &#125;),</span><br><span class="line">  actions: &#123;</span><br><span class="line">    increment() &#123;</span><br><span class="line">      <span class="keyword">this</span>.count++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">const</span> useUserStore = defineStore(&#123;</span><br><span class="line">  id: <span class="string">'counter'</span>,</span><br><span class="line">  state: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    count: <span class="number">0</span></span><br><span class="line">  &#125;),</span><br><span class="line">  actions: &#123;</span><br><span class="line">    increment() &#123;</span><br><span class="line">      <span class="keyword">this</span>.count++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">const</span> useUserStore = defineStore(<span class="string">'counter'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> count = ref(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">increment</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    count.value++</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; count, increment &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="defineStore"><a href="#defineStore" class="headerlink" title="defineStore"></a>defineStore</h2><ul>
<li>ä¸»è¦æ ¹æ®defineStoreçš„ä¸åŒæ–¹å¼é€‰æ‹©è°ƒç”¨å‡½æ•°å¼createSetupStoreè¿˜æ˜¯é€‰é¡¹å¼createOptionsStore</li>
<li>åˆ›å»ºå¥½çš„storeä¼šæ ¹æ®defineStoreæ—¶ä¼ å…¥çš„idï¼ŒæŒ‚è½½åˆ°pinia._sè¿™ä¸ªmapä¸Š</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">defineStore</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="comment">// <span class="doctag">TODO:</span> add proper types from above</span></span></span></span><br><span class="line"><span class="function"><span class="params">  idOrOptions: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  setup?: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  setupOptions?: <span class="built_in">any</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">StoreDefinition</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> id: <span class="built_in">string</span></span><br><span class="line">  <span class="keyword">let</span> options</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> isSetupStore = <span class="keyword">typeof</span> setup === <span class="string">'function'</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æŠ¹å¹³ä¸åŒæ ¼å¼å‚æ•°</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> idOrOptions === <span class="string">'string'</span>) &#123;</span><br><span class="line">    id = idOrOptions</span><br><span class="line">    options = isSetupStore ? setupOptions : setup</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    options = idOrOptions</span><br><span class="line">    id = idOrOptions.id</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æœ€ç»ˆäº¤ç»™å¼€å‘è€…è·å–storeçš„æ–¹æ³•</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">useStore</span>(<span class="params">pinia?: Pinia | <span class="literal">null</span>, hot?: StoreGeneric</span>): <span class="title">StoreGeneric</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">const</span> currentInstance = getCurrentInstance()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœå­˜åœ¨currentInstanceè¯´æ˜åœ¨vueç»„ä»¶ä¸­ï¼Œé€šè¿‡injectè·å–åˆ°pinia</span></span><br><span class="line">    pinia =</span><br><span class="line">      (__TEST__ &amp;&amp; activePinia &amp;&amp; activePinia._testing ? <span class="literal">null</span> : pinia) ||</span><br><span class="line">      (currentInstance &amp;&amp; inject(piniaSymbol, <span class="literal">null</span>))</span><br><span class="line">    </span><br><span class="line">      <span class="comment">//è®¾ç½®å½“å‰æ´»è·ƒçš„piniaå¯¹è±¡ï¼Œå¦‚æœå­˜åœ¨å¤šä¸ªpiniaå¯¹è±¡ï¼Œæ–¹ä¾¿å¿«é€Ÿè·å–å½“å‰piniaå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (pinia) setActivePinia(pinia)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; !activePinia) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">`[ğŸ]: getActivePinia was called with no active Pinia. Did you forget to install pinia?\n`</span> +</span><br><span class="line">          <span class="string">`\tconst pinia = createPinia()\n`</span> +</span><br><span class="line">          <span class="string">`\tapp.use(pinia)\n`</span> +</span><br><span class="line">          <span class="string">`This will fail in production.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä»rootStoreæ–‡ä»¶ä¸­å–çš„å…¨å±€å˜é‡</span></span><br><span class="line">    pinia = activePinia!</span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰åˆ›å»ºè¿‡idå¯¹åº”çš„store,åˆ™ä¼šè°ƒç”¨createSetupStoreæˆ–createOptionsStoreè¿›è¡Œåˆ›å»º</span></span><br><span class="line">    <span class="keyword">if</span> (!pinia._s.has(id)) &#123;</span><br><span class="line">      <span class="comment">// åŒºåˆ†ç¬¬äºŒä¸ªå‚æ•°æ˜¯å‡½æ•°è¿˜æ˜¯optionså¯¹è±¡</span></span><br><span class="line">      <span class="keyword">if</span> (isSetupStore) &#123;</span><br><span class="line">        createSetupStore(id, setup, options, pinia)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        createOptionsStore(id, options <span class="keyword">as</span> <span class="built_in">any</span>, pinia)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="comment">// @ts-expect-error: not the right inferred type</span></span><br><span class="line">        useStore._pinia = pinia</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–ä¸Šé¢åˆ›å»ºå¥½çš„storeï¼Œpinia._sæ˜¯ä¸€ä¸ªMapç»“æ„</span></span><br><span class="line">    <span class="keyword">const</span> store: StoreGeneric = pinia._s.get(id)!</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// çƒ­æ›´æ–°ç›¸å…³,é‡æ–°åˆ›å»ºæ›´æ–°store</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; hot) &#123;</span><br><span class="line">      <span class="keyword">const</span> hotId = <span class="string">'__hot:'</span> + id</span><br><span class="line">      <span class="keyword">const</span> newStore = isSetupStore</span><br><span class="line">        ? createSetupStore(hotId, setup, options, pinia, <span class="literal">true</span>)</span><br><span class="line">        : createOptionsStore(hotId, assign(&#123;&#125;, options) <span class="keyword">as</span> <span class="built_in">any</span>, pinia, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">      hot._hotUpdate(newStore)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// cleanup the state properties and the store from the cache</span></span><br><span class="line">      <span class="keyword">delete</span> pinia.state.value[hotId]</span><br><span class="line">      pinia._s.delete(hotId)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾€å½“å‰ç»„ä»¶å®ä¾‹ä¸Šç¼“å­˜storeï¼Œä¸»è¦æ˜¯ç»™devtoolsä½¿ç”¨</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      __DEV__ &amp;&amp;</span><br><span class="line">      IS_CLIENT &amp;&amp;</span><br><span class="line">      currentInstance &amp;&amp;</span><br><span class="line">      currentInstance.proxy &amp;&amp;</span><br><span class="line">      <span class="comment">// avoid adding stores that are just built for hot module replacement</span></span><br><span class="line">      !hot</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">const</span> vm = currentInstance.proxy</span><br><span class="line">      <span class="keyword">const</span> cache = <span class="string">'_pStores'</span> <span class="keyword">in</span> vm ? vm._pStores! : (vm._pStores = &#123;&#125;)</span><br><span class="line">      cache[id] = store</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// StoreGeneric cannot be casted towards Store</span></span><br><span class="line">    <span class="keyword">return</span> store <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  useStore.$id = id</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> useStore</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="createSetupStore"><a href="#createSetupStore" class="headerlink" title="createSetupStore"></a>createSetupStore</h2><p>å¦‚æœdefineStoreä¼ å…¥çš„æ˜¯ä¸€ä¸ªsetupå‡½æ•°ï¼Œåˆ™ä¼šè°ƒç”¨æ­¤æ–¹æ³•åˆ›å»ºstore</p>
<ul>
<li><h3 id="å“åº”å¼å¤„ç†store"><a href="#å“åº”å¼å¤„ç†store" class="headerlink" title="å“åº”å¼å¤„ç†store"></a>å“åº”å¼å¤„ç†store</h3><ul>
<li>store -&gt; reactive(store)</li>
<li>pinia.state.value[storeId]åˆå§‹åŒ–ï¼Œstateä¼šå¾€piniaä¸Šå­˜ä¸€ä»½å’Œåœ¨storeä¸Šå­˜ä¸€ä»½</li>
<li>å°†storeæ³¨å†Œåˆ°pinia._sè¿™ä¸ªMapä¸Š</li>
</ul>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSetupStore</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  $id: Id,</span></span></span><br><span class="line"><span class="function"><span class="params">  setup: () =&gt; SS,</span></span></span><br><span class="line"><span class="function"><span class="params">  options:</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineSetupStoreOptions&lt;Id, S, G, A&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineStoreOptions&lt;Id, S, G, A&gt; = &#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pinia: Pinia,</span></span></span><br><span class="line"><span class="function"><span class="params">  hot?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  isOptionsStore?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">let</span> scope!: EffectScope  <span class="comment">//ä¸ºsetupå‡½æ•°è¿”å›çš„å†…å®¹å•ç‹¬å»ºç«‹ä¸€ä¸ªscope</span></span><br><span class="line"><span class="keyword">if</span> (__DEV__ &amp;&amp; !pinia._e.active) &#123; <span class="comment">//pinia._eä¸ºåˆ›å»ºpiniaæ—¶å»ºç«‹çš„scope</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Pinia destroyed'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = pinia.state.value[$id] <span class="keyword">as</span> UnwrapRef&lt;S&gt; | <span class="literal">undefined</span></span><br><span class="line"><span class="comment">// å¦‚æœpinia.state.value[storeId]æœªåˆå§‹åŒ–ï¼Œè¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line"><span class="keyword">if</span> (!isOptionsStore &amp;&amp; !initialState &amp;&amp; (!__DEV__ || !hot)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (isVue2) &#123;</span><br><span class="line">    <span class="keyword">set</span>(pinia.state.value, $id, &#123;&#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    pinia.state.value[$id] = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹å¤–æš´éœ²çš„storeå†…å®¹</span></span><br><span class="line"><span class="keyword">const</span> partialStore = &#123;</span><br><span class="line"> _p: pinia,</span><br><span class="line"> <span class="comment">// _s: scope,</span></span><br><span class="line"> $id,</span><br><span class="line"> <span class="comment">// è°ƒç”¨$onActionä¼šå°†å›è°ƒåŠ å…¥åˆ°actionSubscriptionsä¸­,wrapActionå†…ä¼šè§¦å‘å›è°ƒ</span></span><br><span class="line"> $onAction: addSubscription.bind(<span class="literal">null</span>, actionSubscriptions),</span><br><span class="line"> $patch,</span><br><span class="line"> $reset,</span><br><span class="line"> $subscribe(callback, options = &#123;&#125;) &#123;</span><br><span class="line">   <span class="keyword">const</span> removeSubscription = addSubscription(</span><br><span class="line">     subscriptions,</span><br><span class="line">     callback,</span><br><span class="line">     options.detached,</span><br><span class="line">     () =&gt; stopWatcher()</span><br><span class="line">   )</span><br><span class="line">   <span class="comment">// ç›‘å¬stateç›´æ¥ä¿®æ”¹</span></span><br><span class="line">   <span class="keyword">const</span> stopWatcher = scope.run(<span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">     watch(</span><br><span class="line">       () =&gt; pinia.state.value[$id] <span class="keyword">as</span> UnwrapRef&lt;S&gt;,</span><br><span class="line">       (state) =&gt; &#123;</span><br><span class="line">         <span class="comment">// flushé»˜è®¤ä¸º'pre',è€Œåœ¨è°ƒç”¨$patchæ—¶isListeningä¼šè¢«è®¾ç½®ä¸ºfalse,æ‰€ä»¥ä¸ä¼šè§¦å‘$patchä¿®æ”¹stateçš„ç›‘å¬å›è°ƒ</span></span><br><span class="line">         <span class="keyword">if</span> (options.flush === <span class="string">'sync'</span> ? isSyncListening : isListening) &#123;</span><br><span class="line">           callback(</span><br><span class="line">             &#123;</span><br><span class="line">               storeId: $id,</span><br><span class="line">               <span class="keyword">type</span>: MutationType.direct,</span><br><span class="line">               events: debuggerEvents <span class="keyword">as</span> DebuggerEvent,</span><br><span class="line">             &#125;,</span><br><span class="line">             state</span><br><span class="line">           )</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;,</span><br><span class="line">       assign(&#123;&#125;, $subscribeOptions, options)</span><br><span class="line">     )</span><br><span class="line">   )!</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> removeSubscription</span><br><span class="line"> &#125;,</span><br><span class="line"> $dispose,</span><br><span class="line">&#125; <span class="keyword">as</span> _StoreWithState&lt;Id, S, G, A&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›çš„storeæ˜¯ä¸ªreactiveå¯¹è±¡</span></span><br><span class="line"><span class="keyword">const</span> store: Store&lt;Id, S, G, A&gt; = reactive(</span><br><span class="line">  __DEV__ || USE_DEVTOOLS</span><br><span class="line">    ? assign(</span><br><span class="line">        &#123;</span><br><span class="line">          _hmrPayload,</span><br><span class="line">          _customProperties: markRaw(<span class="keyword">new</span> Set&lt;<span class="built_in">string</span>&gt;()), <span class="comment">// devtools custom properties</span></span><br><span class="line">        &#125;,</span><br><span class="line">        partialStore</span><br><span class="line">        <span class="comment">// must be added later</span></span><br><span class="line">        <span class="comment">// setupStore</span></span><br><span class="line">      )</span><br><span class="line">    : partialStore</span><br><span class="line">) <span class="keyword">as</span> unknown <span class="keyword">as</span> Store&lt;Id, S, G, A&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†storeæ³¨å†Œåˆ°piniaä¸Š</span></span><br><span class="line">pinia._s.set($id, store)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h3 id="å¤„ç†setupè¿”å›çš„å†…å®¹"><a href="#å¤„ç†setupè¿”å›çš„å†…å®¹" class="headerlink" title="å¤„ç†setupè¿”å›çš„å†…å®¹"></a>å¤„ç†setupè¿”å›çš„å†…å®¹</h3></li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">createSetupStore</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  $id: Id,</span></span></span><br><span class="line"><span class="function"><span class="params">  setup: () =&gt; SS,</span></span></span><br><span class="line"><span class="function"><span class="params">  options:</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineSetupStoreOptions&lt;Id, S, G, A&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineStoreOptions&lt;Id, S, G, A&gt; = &#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pinia: Pinia,</span></span></span><br><span class="line"><span class="function"><span class="params">  hot?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  isOptionsStore?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>)</span>&#123;</span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">// å°†defineStoreä½¿ç”¨è€…å®šä¹‰çš„è¿”å›å†…å®¹æ”¾è¿›scopeä¸­,åœ¨ç»„ä»¶å¸è½½æ—¶å›æ”¶effect</span></span><br><span class="line"> <span class="keyword">const</span> setupStore = pinia._e.run(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">   scope = effectScope()</span><br><span class="line">   <span class="keyword">return</span> scope.run(<span class="function"><span class="params">()</span> =&gt;</span> setup())</span><br><span class="line"> &#125;)!</span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h3 id="åŒæ­¥setupè¿”å›å†…å®¹å’Œpinia-state"><a href="#åŒæ­¥setupè¿”å›å†…å®¹å’Œpinia-state" class="headerlink" title="åŒæ­¥setupè¿”å›å†…å®¹å’Œpinia.state"></a>åŒæ­¥setupè¿”å›å†…å®¹å’Œpinia.state</h3><ul>
<li>å› ä¸ºstateä¼šåœ¨storeä¸Šå­˜ä¸€ä»½ï¼Œä¹Ÿä¼šåœ¨pinia.state.value[storeId]ä¸Šå­˜ä¸€ä»½ï¼Œæ‰€ä»¥ä¸ºäº†ä¿è¯ä¸¤è¾¹éƒ½æ˜¯åŒä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œéœ€è¦è¿›è¡ŒåŒæ­¥</li>
<li>ä½¿ç”¨è€…å¯ä»¥ç›´æ¥é€šè¿‡pinia.state.valueè®¾ç½®storeå†…å®¹ï¼Œæ‰€ä»¥ç›´æ¥è®¾ç½®çš„å†…å®¹ä¹Ÿéœ€è¦åŒæ­¥</li>
</ul>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">createSetupStore</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  $id: Id,</span></span></span><br><span class="line"><span class="function"><span class="params">  setup: () =&gt; SS,</span></span></span><br><span class="line"><span class="function"><span class="params">  options:</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineSetupStoreOptions&lt;Id, S, G, A&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineStoreOptions&lt;Id, S, G, A&gt; = &#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pinia: Pinia,</span></span></span><br><span class="line"><span class="function"><span class="params">  hot?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  isOptionsStore?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>)</span>&#123;</span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// å°†defineStoreä½¿ç”¨è€…å®šä¹‰çš„è¿”å›å†…å®¹æ”¾è¿›scopeä¸­,åœ¨ç»„ä»¶å¸è½½æ—¶å›æ”¶effect</span></span><br><span class="line"><span class="keyword">const</span> setupStore = pinia._e.run(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  scope = effectScope()</span><br><span class="line">  <span class="keyword">return</span> scope.run(<span class="function"><span class="params">()</span> =&gt;</span> setup())</span><br><span class="line">&#125;)!</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> setupStore) &#123;</span><br><span class="line"> <span class="keyword">const</span> prop = setupStore[key]</span><br><span class="line"> <span class="comment">// åªå¤„ç†refã€reactiveå¯¹è±¡ï¼Œcomputedç­‰ä¸å¤„ç†</span></span><br><span class="line"> <span class="keyword">if</span> ((isRef(prop) &amp;&amp; !isComputed(prop)) || isReactive(prop)) &#123;</span><br><span class="line">   <span class="comment">// mark it as a piece of state to be serialized</span></span><br><span class="line">   <span class="keyword">if</span> (__DEV__ &amp;&amp; hot) &#123;</span><br><span class="line">     <span class="comment">// çƒ­æ›´æ–°ç›¸å…³ï¼Œå¿½ç•¥</span></span><br><span class="line">     <span class="keyword">set</span>(hotState.value, key, toRef(setupStore <span class="keyword">as</span> <span class="built_in">any</span>, key))</span><br><span class="line">     <span class="comment">// optionç»“æ„å·²ç»åœ¨createOptionsStoreå°†å…¶åŠ å…¥pinia</span></span><br><span class="line">     </span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isOptionsStore) &#123;<span class="comment">// åŒæ­¥pinia.state -&gt; store</span></span><br><span class="line">   </span><br><span class="line">     <span class="comment">// å°†ç”¨æˆ·å¯èƒ½ç›´æ¥è°ƒç”¨pinia.state.value[$id]è®¾ç½®çš„refã€reactiveå¯¹è±¡è®¾ç½®åˆ°setupè¿”å›çš„ç»“æœä¸Š,è®©äºŒè€…çš„å“åº”å¼éƒ½ä»£ç†ä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line">     <span class="comment">// ä½¿å¾—storeã€piniaèƒ½åŒæ­¥æ›´æ”¹</span></span><br><span class="line">     <span class="keyword">if</span> (initialState &amp;&amp; shouldHydrate(prop)) &#123;</span><br><span class="line">       <span class="keyword">if</span> (isRef(prop)) &#123;</span><br><span class="line">         prop.value = initialState[key]</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// probably a reactive object, lets recursively assign</span></span><br><span class="line">         <span class="comment">// åŒæ­¥å…¶ä»–ç±»å‹</span></span><br><span class="line">         mergeReactiveObjects(prop, initialState[key])</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// transfer the ref to the pinia state to keep everything in sync</span></span><br><span class="line">     <span class="comment">// å°†setupè¿”å›çš„refã€reactiveå¯¹è±¡åŒæ­¥åˆ°pinia.stateä¸Šï¼Œä½¿å¾—storeã€piniaèƒ½åŒæ­¥æ›´æ”¹</span></span><br><span class="line">     <span class="keyword">if</span> (isVue2) &#123; <span class="comment">//åŒæ­¥ store -&gt; pinia.state</span></span><br><span class="line">       <span class="keyword">set</span>(pinia.state.value[$id], key, prop)</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       pinia.state.value[$id][key] = prop</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå¹¶æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeReactiveObjects</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">T</span> <span class="title">extends</span> <span class="title">Record</span>&lt;<span class="title">any</span>, <span class="title">unknown</span>&gt; | <span class="title">Map</span>&lt;<span class="title">unknown</span>, <span class="title">unknown</span>&gt; | <span class="title">Set</span>&lt;<span class="title">unknown</span>&gt;</span></span><br><span class="line"><span class="function">&gt;(<span class="params">target: T, patchToApply: _DeepPartial&lt;T&gt;</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆå¹¶Mapç±»å‹</span></span><br><span class="line">  <span class="keyword">if</span> (target <span class="keyword">instanceof</span> Map &amp;&amp; patchToApply <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">    patchToApply.forEach(<span class="function">(<span class="params">value, key</span>) =&gt;</span> target.set(key, value))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åˆå¹¶Setç±»å‹</span></span><br><span class="line">  <span class="keyword">if</span> (target <span class="keyword">instanceof</span> Set &amp;&amp; patchToApply <span class="keyword">instanceof</span> Set) &#123;</span><br><span class="line">    patchToApply.forEach(target.add, target)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> patchToApply) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!patchToApply.hasOwnProperty(key)) <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">const</span> subPatch = patchToApply[key]</span><br><span class="line">    <span class="keyword">const</span> targetValue = target[key]</span><br><span class="line">    <span class="comment">// åªæœ‰æ™®é€šå¯¹è±¡æ‰ä¼šè¿›å…¥é€’å½’</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      isPlainObject(targetValue) &amp;&amp;</span><br><span class="line">      isPlainObject(subPatch) &amp;&amp;</span><br><span class="line">      target.hasOwnProperty(key) &amp;&amp;</span><br><span class="line">      !isRef(subPatch) &amp;&amp;</span><br><span class="line">      !isReactive(subPatch)</span><br><span class="line">    ) &#123;</span><br><span class="line">      target[key] = mergeReactiveObjects(targetValue, subPatch)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      target[key] = subPatch</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> target</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h3 id="å¤„ç†action"><a href="#å¤„ç†action" class="headerlink" title="å¤„ç†action"></a>å¤„ç†action</h3><ul>
<li>å°†actionæ›¿æ¢æˆwrapActionï¼ŒwrapActionæ·»åŠ äº†è®¢é˜…å‘å¸ƒç›¸å…³çš„åŠŸèƒ½</li>
</ul>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">createSetupStore</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  $id: Id,</span></span></span><br><span class="line"><span class="function"><span class="params">  setup: () =&gt; SS,</span></span></span><br><span class="line"><span class="function"><span class="params">  options:</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineSetupStoreOptions&lt;Id, S, G, A&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineStoreOptions&lt;Id, S, G, A&gt; = &#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pinia: Pinia,</span></span></span><br><span class="line"><span class="function"><span class="params">  hot?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  isOptionsStore?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>)</span>&#123;</span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// å°†defineStoreä½¿ç”¨è€…å®šä¹‰çš„è¿”å›å†…å®¹æ”¾è¿›scopeä¸­,åœ¨ç»„ä»¶å¸è½½æ—¶å›æ”¶effect</span></span><br><span class="line"><span class="keyword">const</span> setupStore = pinia._e.run(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  scope = effectScope()</span><br><span class="line">  <span class="keyword">return</span> scope.run(<span class="function"><span class="params">()</span> =&gt;</span> setup())</span><br><span class="line">&#125;)!</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> setupStore) &#123;</span><br><span class="line"> <span class="keyword">const</span> prop = setupStore[key]</span><br><span class="line"> <span class="comment">// åªå¤„ç†refã€reactiveå¯¹è±¡ï¼Œcomputedç­‰ä¸å¤„ç†</span></span><br><span class="line"> <span class="keyword">if</span> ((isRef(prop) &amp;&amp; !isComputed(prop)) || isReactive(prop)) &#123;</span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line"> &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> prop === <span class="string">'function'</span>) &#123; </span><br><span class="line"> </span><br><span class="line">  <span class="comment">// å°†setupä¸­çš„æ–¹æ³•æ›¿æ¢æˆwrapActionåŒ…è£…çš„æ–¹æ³•ï¼ŒwrapActionåœ¨è®¢é˜…å‘å¸ƒç« èŠ‚è§£æ</span></span><br><span class="line">  </span><br><span class="line">      <span class="keyword">const</span> actionValue = __DEV__ &amp;&amp; hot ? prop : wrapAction(key, prop)</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (isVue2) &#123;</span><br><span class="line">        <span class="keyword">set</span>(setupStore, key, actionValue)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// @ts-expect-error</span></span><br><span class="line">        setupStore[key] = actionValue</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        _hmrPayload.actions[key] = prop</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// list actions so they can be used in plugins</span></span><br><span class="line">      <span class="comment">// @ts-expect-error</span></span><br><span class="line">      optionsForPlugin.actions[key] = prop</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h3 id="å¤„ç†storeåˆå¹¶setup"><a href="#å¤„ç†storeåˆå¹¶setup" class="headerlink" title="å¤„ç†storeåˆå¹¶setup"></a>å¤„ç†storeåˆå¹¶setup</h3></li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">createSetupStore</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  $id: Id,</span></span></span><br><span class="line"><span class="function"><span class="params">  setup: () =&gt; SS,</span></span></span><br><span class="line"><span class="function"><span class="params">  options:</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineSetupStoreOptions&lt;Id, S, G, A&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineStoreOptions&lt;Id, S, G, A&gt; = &#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pinia: Pinia,</span></span></span><br><span class="line"><span class="function"><span class="params">  hot?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  isOptionsStore?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// å¯¹å¤–æš´éœ²çš„store API</span></span><br><span class="line"><span class="keyword">const</span> partialStore = &#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> store: Store&lt;Id, S, G, A&gt; = reactive(</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">partialStore</span><br><span class="line">)</span><br><span class="line"><span class="comment">// å°†defineStoreä½¿ç”¨è€…å®šä¹‰çš„è¿”å›å†…å®¹æ”¾è¿›scopeä¸­,åœ¨ç»„ä»¶å¸è½½æ—¶å›æ”¶effect</span></span><br><span class="line"><span class="keyword">const</span> setupStore = pinia._e.run(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">scope = effectScope()</span><br><span class="line"><span class="keyword">return</span> scope.run(<span class="function"><span class="params">()</span> =&gt;</span> setup())</span><br><span class="line">&#125;)!</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> setupStore) &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// å°†æœ€åŒæ­¥åçš„ç»“æœï¼Œåˆå¹¶è¿›storeä¸Š</span></span><br><span class="line"> <span class="keyword">if</span> (isVue2) &#123;</span><br><span class="line">   <span class="built_in">Object</span>.keys(setupStore).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">set</span>(store, key, setupStore[key])</span><br><span class="line">   &#125;)</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="comment">// å°†storeçš„reactiveå¯¹è±¡ã€åŸå§‹å¯¹è±¡éƒ½è¿›è¡Œåˆå¹¶</span></span><br><span class="line">   assign(store, setupStore)</span><br><span class="line">   assign(toRaw(store), setupStore)</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="createOptionsStore"><a href="#createOptionsStore" class="headerlink" title="createOptionsStore"></a>createOptionsStore</h2><p>å½“ä¼ å…¥çš„æ˜¯optioné…ç½®æ—¶ï¼Œåˆ™ä¼šè°ƒç”¨æ­¤æ–¹æ³•åˆ›å»ºstore</p>
<ul>
<li>createSetupStoreå†…éƒ¨ä¼šå°†optionè½¬æ¢æˆsetupæ–¹æ³•ï¼Œç„¶åå®é™…è°ƒç”¨createSetupStoreè¿›è¡Œåˆ›å»º</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createOptionsStore</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">Id</span> <span class="title">extends</span> <span class="title">string</span>,</span></span><br><span class="line"><span class="function">  <span class="title">S</span> <span class="title">extends</span> <span class="title">StateTree</span>,</span></span><br><span class="line"><span class="function">  <span class="title">G</span> <span class="title">extends</span> <span class="title">_GettersTree</span>&lt;<span class="title">S</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">A</span> <span class="title">extends</span> <span class="title">_ActionsTree</span></span></span><br><span class="line"><span class="function">&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  id: Id,</span></span></span><br><span class="line"><span class="function"><span class="params">  options: DefineStoreOptions&lt;Id, S, G, A&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pinia: Pinia,</span></span></span><br><span class="line"><span class="function"><span class="params">  hot?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Store</span>&lt;<span class="title">Id</span>, <span class="title">S</span>, <span class="title">G</span>, <span class="title">A</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; state, actions, getters &#125; = options</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> initialState: StateTree | <span class="literal">undefined</span> = pinia.state.value[id]</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">let</span> store: Store&lt;Id, S, G, A&gt;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å°†optionsè½¬åŒ–æˆsetupå‡½æ•°</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–pinia.state</span></span><br><span class="line">    <span class="keyword">if</span> (!initialState &amp;&amp; (!__DEV__ || !hot)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isVue2) &#123;</span><br><span class="line">        <span class="keyword">set</span>(pinia.state.value, id, state ? state() : &#123;&#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pinia.state.value[id] = state ? state() : &#123;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°†pinia.stateå…¨éƒ¨è½¬æ¢æˆrefï¼Œå’Œsetupä¸­è¿”å›refæ•ˆæœä¸€è‡´</span></span><br><span class="line">    <span class="keyword">const</span> localState =</span><br><span class="line">      __DEV__ &amp;&amp; hot</span><br><span class="line">        ? <span class="comment">// use ref() to unwrap refs inside state <span class="doctag">TODO:</span> check if this is still necessary</span></span><br><span class="line">          toRefs(ref(state ? state() : &#123;&#125;).value)</span><br><span class="line">        : toRefs(pinia.state.value[id])</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æœ€ç»ˆoptions storeè¿”å›çš„å†…å®¹æ ¼å¼å’Œsetup storeè¿”å›çš„å†…å®¹æ ¼å¼ä¸€è‡´</span></span><br><span class="line">    <span class="keyword">return</span> assign(</span><br><span class="line">      localState,</span><br><span class="line">      actions,</span><br><span class="line">      <span class="comment">// å°† getter è½¬æ¢æˆ computed</span></span><br><span class="line">      <span class="built_in">Object</span>.keys(getters || &#123;&#125;).reduce(<span class="function">(<span class="params">computedGetters, name</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__ &amp;&amp; name <span class="keyword">in</span> localState) &#123;</span><br><span class="line">          <span class="built_in">console</span>.warn(</span><br><span class="line">            <span class="string">`[ğŸ]: A getter cannot have the same name as another state property. Rename one of them. Found with "<span class="subst">$&#123;name&#125;</span>" in store "<span class="subst">$&#123;id&#125;</span>".`</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// getterå‡½æ•°ä¸å¯ä»£ç†ï¼ŒåŠä¸å¯¹computedåšé¢å¤–å¤„ç†ï¼Œå’Œsetupä¸­ä¸€è‡´</span></span><br><span class="line">        computedGetters[name] = markRaw(</span><br><span class="line">          computed(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            setActivePinia(pinia)</span><br><span class="line">            <span class="comment">// it was created just before</span></span><br><span class="line">            <span class="keyword">const</span> store = pinia._s.get(id)!</span><br><span class="line"></span><br><span class="line">            <span class="comment">// allow cross using stores</span></span><br><span class="line">            <span class="keyword">if</span> (isVue2 &amp;&amp; !store._r) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// @ts-expect-error</span></span><br><span class="line">            <span class="comment">// return getters![name].call(context, context)</span></span><br><span class="line">            <span class="keyword">return</span> getters![name].call(store, store)</span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> computedGetters</span><br><span class="line">      &#125;, &#123;&#125; <span class="keyword">as</span> Record&lt;<span class="built_in">string</span>, ComputedRef&gt;)</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// optioné€‰é¡¹æ³¨å†Œçš„piniaä¼šè¢«è½¬æ¢æˆsetupå‡½æ•°å½¢å¼</span></span><br><span class="line">  store = createSetupStore(id, setup, options, pinia, hot, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">  store.$reset = <span class="function"><span class="keyword">function</span> <span class="title">$reset</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> newState = state ? state() : &#123;&#125;</span><br><span class="line">    <span class="comment">// we use a patch to group all changes into one single subscription</span></span><br><span class="line">    <span class="keyword">this</span>.$patch(<span class="function">(<span class="params">$state</span>) =&gt;</span> &#123;</span><br><span class="line">      assign($state, newState)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> store <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="è®¢é˜…å‘å¸ƒ"><a href="#è®¢é˜…å‘å¸ƒ" class="headerlink" title="è®¢é˜…å‘å¸ƒ"></a>è®¢é˜…å‘å¸ƒ</h2><p>piniaèƒ½å¤Ÿå¯¹ä¿®æ”¹stateã€actionè¿›è¡Œç›‘å¬ï¼Œå†…éƒ¨é€šè¿‡å‘å¸ƒè®¢é˜…æ¨¡å¼ã€watch APIå®ç°</p>
<ul>
<li><h2 id="å‘å¸ƒè®¢é˜…æ¨¡å¼"><a href="#å‘å¸ƒè®¢é˜…æ¨¡å¼" class="headerlink" title="å‘å¸ƒè®¢é˜…æ¨¡å¼"></a>å‘å¸ƒè®¢é˜…æ¨¡å¼</h2><ul>
<li>å°†å­˜å‚¨è®¢é˜…å™¨çš„åŠŸèƒ½å’Œæ•´ä¸ªè®¾è®¡è§£è—•ï¼Œäº¤ç»™å¤–éƒ¨æ¥ä¼ å…¥ï¼Œå¥½å¤„æ˜¯èƒ½å¤Ÿå¤„ç†ä¸åŒç±»å‹çš„å‘å¸ƒè®¢é˜…</li>
</ul>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//subscriptions.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">addSubscription</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">_Method</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  subscriptions: T[], <span class="comment">//å¤–éƒ¨ä¼ å…¥å­˜å‚¨å™¨</span></span></span></span><br><span class="line"><span class="function"><span class="params">  callback: T,</span></span></span><br><span class="line"><span class="function"><span class="params">  detached?: <span class="built_in">boolean</span>, <span class="comment">// æ˜¯å¦åœ¨ç»„ä»¶å¸è½½æ—¶æ¸…é™¤è®¢é˜…</span></span></span></span><br><span class="line"><span class="function"><span class="params">  onCleanup: () =&gt; <span class="built_in">void</span> = noop</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  subscriptions.push(callback)</span><br><span class="line">  <span class="comment">// æ¸…é™¤è®¢é˜…</span></span><br><span class="line">  <span class="keyword">const</span> removeSubscription = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> idx = subscriptions.indexOf(callback)</span><br><span class="line">    <span class="keyword">if</span> (idx &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      subscriptions.splice(idx, <span class="number">1</span>)</span><br><span class="line">      onCleanup()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¦‚æœæ²¡ä¼ detached,åˆ™ä¼šè‡ªåŠ¨åœ¨ç»„ä»¶å¸è½½æ—¶æ¸…é™¤è®¢é˜…</span></span><br><span class="line">  <span class="keyword">if</span> (!detached &amp;&amp; getCurrentScope()) &#123;</span><br><span class="line">    onScopeDispose(removeSubscription)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> removeSubscription</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">triggerSubscriptions</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">_Method</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  subscriptions: T[],</span></span></span><br><span class="line"><span class="function"><span class="params">  ...args: Parameters&lt;T&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  subscriptions.slice().forEach(<span class="function">(<span class="params">callback</span>) =&gt;</span> &#123;</span><br><span class="line">    callback(...args)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h2 id="ç›‘å¬action"><a href="#ç›‘å¬action" class="headerlink" title="ç›‘å¬action"></a>ç›‘å¬action</h2></li>
</ul>
<p>åŸºæœ¬ä½¿ç”¨</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> unsubscribe = someStore.$onAction(</span><br><span class="line">  (&#123;</span><br><span class="line">    name, <span class="comment">// action åç§°</span></span><br><span class="line">    store, <span class="comment">// store å®ä¾‹ï¼Œç±»ä¼¼ `someStore`</span></span><br><span class="line">    args, <span class="comment">// ä¼ é€’ç»™ action çš„å‚æ•°æ•°ç»„</span></span><br><span class="line">    after, <span class="comment">// åœ¨ action è¿”å›æˆ–è§£å†³åçš„é’©å­</span></span><br><span class="line">    onError, <span class="comment">// action æŠ›å‡ºæˆ–æ‹’ç»çš„é’©å­</span></span><br><span class="line">  &#125;) =&gt; &#123;</span><br><span class="line">    <span class="comment">// è¿™å°†åœ¨æ‰§è¡Œ "store "çš„ action ä¹‹å‰è§¦å‘ã€‚</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`xx`</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™å°†åœ¨ action æˆåŠŸå¹¶å®Œå…¨è¿è¡Œåè§¦å‘ã€‚å®ƒç­‰å¾…ç€ä»»ä½•è¿”å›çš„ promise</span></span><br><span class="line">    after(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(</span><br><span class="line">        <span class="string">`Finished "<span class="subst">$&#123;name&#125;</span>" after <span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">          <span class="built_in">Date</span>.now() - startTime</span></span></span><br><span class="line"><span class="string"><span class="subst">        &#125;</span>ms.\nResult: <span class="subst">$&#123;result&#125;</span>.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœ action æŠ›å‡ºæˆ–è¿”å›ä¸€ä¸ªæ‹’ç»çš„ promiseï¼Œè¿™å°†è§¦å‘</span></span><br><span class="line">    onError(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.warn(</span><br><span class="line">        <span class="string">`Failed "<span class="subst">$&#123;name&#125;</span>" after <span class="subst">$&#123;<span class="built_in">Date</span>.now() - startTime&#125;</span>ms.\nError: <span class="subst">$&#123;error&#125;</span>.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰‹åŠ¨åˆ é™¤ç›‘å¬å™¨</span></span><br><span class="line">unsubscribe()</span><br></pre></td></tr></table></figure>

<h3 id="é€šè¿‡-onActionæ·»åŠ è®¢é˜…"><a href="#é€šè¿‡-onActionæ·»åŠ è®¢é˜…" class="headerlink" title="é€šè¿‡$onActionæ·»åŠ è®¢é˜…"></a>é€šè¿‡$onActionæ·»åŠ è®¢é˜…</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSetupStore</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">Id</span> <span class="title">extends</span> <span class="title">string</span>,</span></span><br><span class="line"><span class="function">  <span class="title">SS</span> <span class="title">extends</span> <span class="title">Record</span>&lt;<span class="title">any</span>, <span class="title">unknown</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">S</span> <span class="title">extends</span> <span class="title">StateTree</span>,</span></span><br><span class="line"><span class="function">  <span class="title">G</span> <span class="title">extends</span> <span class="title">Record</span>&lt;<span class="title">string</span>, <span class="title">_Method</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">A</span> <span class="title">extends</span> <span class="title">_ActionsTree</span></span></span><br><span class="line"><span class="function">&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  $id: Id,</span></span></span><br><span class="line"><span class="function"><span class="params">  setup: () =&gt; SS,</span></span></span><br><span class="line"><span class="function"><span class="params">  options:</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineSetupStoreOptions&lt;Id, S, G, A&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineStoreOptions&lt;Id, S, G, A&gt; = &#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pinia: Pinia,</span></span></span><br><span class="line"><span class="function"><span class="params">  hot?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  isOptionsStore?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Store</span>&lt;<span class="title">Id</span>, <span class="title">S</span>, <span class="title">G</span>, <span class="title">A</span>&gt; </span>&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// å¯¹å¤–æš´éœ²çš„storeå†…å®¹</span></span><br><span class="line"><span class="keyword">const</span> partialStore = &#123;</span><br><span class="line"> _p: pinia,</span><br><span class="line"> <span class="comment">// _s: scope,</span></span><br><span class="line"> $id,</span><br><span class="line"> <span class="comment">// è°ƒç”¨$onActionä¼šå°†å›è°ƒåŠ å…¥åˆ°actionSubscriptionsä¸­,è°ƒç”¨wrapActionå†…ä¼šè§¦å‘å›è°ƒ</span></span><br><span class="line"> $onAction: addSubscription.bind(<span class="literal">null</span>, actionSubscriptions),</span><br><span class="line"> $patch,</span><br><span class="line"> $reset,</span><br><span class="line"> $subscribe(callback, options = &#123;&#125;) &#123;</span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line"> &#125;,</span><br><span class="line"> $dispose,</span><br><span class="line">&#125; <span class="keyword">as</span> _StoreWithState&lt;Id, S, G, A&gt;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é€šè¿‡wrapActionè¿›è¡Œå‘å¸ƒ"><a href="#é€šè¿‡wrapActionè¿›è¡Œå‘å¸ƒ" class="headerlink" title="é€šè¿‡wrapActionè¿›è¡Œå‘å¸ƒ"></a>é€šè¿‡wrapActionè¿›è¡Œå‘å¸ƒ</h3><ul>
<li>setupã€optionä¸­çš„æ–¹æ³•ï¼Œä¼šè¢«æ›¿æ¢æˆwrapAction</li>
<li>å½“è°ƒç”¨wrapActionæ—¶ï¼Œä¼šè§¦å‘actionSubscriptionsã€afterCallbackListæˆ–onErrorCallbackListä¸­çš„å›è°ƒ</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSetupStore</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">Id</span> <span class="title">extends</span> <span class="title">string</span>,</span></span><br><span class="line"><span class="function">  <span class="title">SS</span> <span class="title">extends</span> <span class="title">Record</span>&lt;<span class="title">any</span>, <span class="title">unknown</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">S</span> <span class="title">extends</span> <span class="title">StateTree</span>,</span></span><br><span class="line"><span class="function">  <span class="title">G</span> <span class="title">extends</span> <span class="title">Record</span>&lt;<span class="title">string</span>, <span class="title">_Method</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">A</span> <span class="title">extends</span> <span class="title">_ActionsTree</span></span></span><br><span class="line"><span class="function">&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  $id: Id,</span></span></span><br><span class="line"><span class="function"><span class="params">  setup: () =&gt; SS,</span></span></span><br><span class="line"><span class="function"><span class="params">  options:</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineSetupStoreOptions&lt;Id, S, G, A&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineStoreOptions&lt;Id, S, G, A&gt; = &#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pinia: Pinia,</span></span></span><br><span class="line"><span class="function"><span class="params">  hot?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  isOptionsStore?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Store</span>&lt;<span class="title">Id</span>, <span class="title">S</span>, <span class="title">G</span>, <span class="title">A</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// internal state</span></span><br><span class="line"><span class="keyword">let</span> isListening: <span class="built_in">boolean</span> <span class="comment">// å¼‚æ­¥ç›‘å¬</span></span><br><span class="line"><span class="keyword">let</span> isSyncListening: <span class="built_in">boolean</span> <span class="comment">// åŒæ­¥ç›‘å¬</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> subscriptions: SubscriptionCallback&lt;S&gt;[] = markRaw([])  <span class="comment">// ç›‘å¬stateçš„è®¢é˜…é›†åˆ</span></span><br><span class="line"><span class="keyword">let</span> actionSubscriptions: StoreOnActionListener&lt;Id, S, G, A&gt;[] = markRaw([]) <span class="comment">// ç›‘å¬actionçš„è®¢é˜…é›†åˆ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒ…è£…actionè°ƒç”¨ï¼Œè¿½åŠ å‘å¸ƒè®¢é˜…åŠŸèƒ½</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wrapAction</span>(<span class="params">name: <span class="built_in">string</span>, action: _Method</span>) </span>&#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"><span class="keyword">this</span>: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">   <span class="comment">// æ ¹æ®é—­åŒ…ä¸Šä¸‹æ–‡ï¼Œè°ƒç”¨æ—¶è®¾ç½®å½“å‰æ´»è·ƒçš„pinia</span></span><br><span class="line">   setActivePinia(pinia)</span><br><span class="line">   <span class="keyword">const</span> args = <span class="built_in">Array</span>.from(<span class="built_in">arguments</span>)</span><br><span class="line">   <span class="comment">// è°ƒç”¨actionåå›è°ƒé›†åˆ</span></span><br><span class="line">   <span class="keyword">const</span> afterCallbackList: <span class="built_in">Array</span>&lt;<span class="function">(<span class="params">resolvedReturn: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">any</span>&gt; = []</span><br><span class="line">   <span class="keyword">const</span> onErrorCallbackList: <span class="built_in">Array</span>&lt;<span class="function">(<span class="params">error: unknown</span>) =&gt;</span> unknown&gt; = []</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">after</span>(<span class="params">callback: _ArrayType&lt;<span class="keyword">typeof</span> afterCallbackList&gt;</span>) </span>&#123;</span><br><span class="line">     afterCallbackList.push(callback)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">onError</span>(<span class="params">callback: _ArrayType&lt;<span class="keyword">typeof</span> onErrorCallbackList&gt;</span>) </span>&#123;</span><br><span class="line">     onErrorCallbackList.push(callback)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// è§¦å‘actionæ—¶çš„å›è°ƒï¼ŒåŒæ—¶å°†afterç­‰æ–¹æ³•é€šè¿‡å‚æ•°ä¼ å…¥</span></span><br><span class="line">   triggerSubscriptions(actionSubscriptions, &#123;</span><br><span class="line">     args,</span><br><span class="line">     name,</span><br><span class="line">     store,</span><br><span class="line">     after,</span><br><span class="line">     onError,</span><br><span class="line">   &#125;)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">let</span> ret: <span class="built_in">any</span></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     ret = action.apply(<span class="keyword">this</span> &amp;&amp; <span class="keyword">this</span>.$id === $id ? <span class="keyword">this</span> : store, args)</span><br><span class="line">   &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">     <span class="comment">// å¤„ç†åŒæ­¥é”™è¯¯</span></span><br><span class="line">     triggerSubscriptions(onErrorCallbackList, error)</span><br><span class="line">     <span class="keyword">throw</span> error</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// å¦‚æœæ˜¯å¼‚æ­¥æ–¹æ³•</span></span><br><span class="line">   <span class="keyword">if</span> (ret <span class="keyword">instanceof</span> <span class="built_in">Promise</span>) &#123;</span><br><span class="line">     <span class="keyword">return</span> ret</span><br><span class="line">       .then(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">         <span class="comment">// è·å–åˆ°actionè°ƒç”¨ç»“æœåè§¦å‘</span></span><br><span class="line">         triggerSubscriptions(afterCallbackList, value)</span><br><span class="line">         <span class="keyword">return</span> value</span><br><span class="line">       &#125;)</span><br><span class="line">       .catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">         triggerSubscriptions(onErrorCallbackList, error)</span><br><span class="line">         <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error)</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// allow the afterCallback to override the return value</span></span><br><span class="line">   triggerSubscriptions(afterCallbackList, ret)</span><br><span class="line">   <span class="keyword">return</span> ret</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç›‘å¬ä¿®æ”¹state"><a href="#ç›‘å¬ä¿®æ”¹state" class="headerlink" title="ç›‘å¬ä¿®æ”¹state"></a>ç›‘å¬ä¿®æ”¹state</h2><p>ä¿®æ”¹stateæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§é€šè¿‡store.stateç›´æ¥ä¿®æ”¹ç„¶åé€šè¿‡watch APIè¿›è¡Œç›‘å¬ï¼Œå¦ä¸€ç§é€šè¿‡$patchè¿›è¡Œ<a href="https://so.csdn.net/so/search?q=%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9&spm=1001.2101.3001.7020" target="_blank" rel="noopener">æ‰¹é‡ä¿®æ”¹</a>ï¼Œé€šè¿‡$patchè¿›è¡Œæ‰¹é‡ä¿®æ”¹æ—¶ï¼Œä¸ºäº†åªè§¦å‘ä¸€æ¬¡å›è°ƒéœ€è¦æ‰‹åŠ¨è§¦å‘</p>
<ul>
<li>åŸºæœ¬ä½¿ç”¨</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cartStore.$subscribe(<span class="function">(<span class="params">mutation, state</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// import &#123; MutationType &#125; from 'pinia'</span></span><br><span class="line">  mutation.type <span class="comment">// 'direct' | 'patch object' | 'patch function'</span></span><br><span class="line">  <span class="comment">// å’Œ cartStore.$id ä¸€æ ·</span></span><br><span class="line">  mutation.storeId <span class="comment">// 'cart'</span></span><br><span class="line">  <span class="comment">// åªæœ‰ mutation.type === 'patch object'çš„æƒ…å†µä¸‹æ‰å¯ç”¨</span></span><br><span class="line">  mutation.payload <span class="comment">// ä¼ é€’ç»™ cartStore.$patch() çš„è¡¥ä¸å¯¹è±¡ã€‚</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li><h3 id="ç›´æ¥ä¿®æ”¹state"><a href="#ç›´æ¥ä¿®æ”¹state" class="headerlink" title="ç›´æ¥ä¿®æ”¹state"></a>ç›´æ¥ä¿®æ”¹state</h3></li>
</ul>
<p>$subscribeç›‘å¬stateç›´æ¥ä¿®æ”¹ï¼Œå†…éƒ¨é€šè¿‡watch APIå®ç°</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSetupStore</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">Id</span> <span class="title">extends</span> <span class="title">string</span>,</span></span><br><span class="line"><span class="function">  <span class="title">SS</span> <span class="title">extends</span> <span class="title">Record</span>&lt;<span class="title">any</span>, <span class="title">unknown</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">S</span> <span class="title">extends</span> <span class="title">StateTree</span>,</span></span><br><span class="line"><span class="function">  <span class="title">G</span> <span class="title">extends</span> <span class="title">Record</span>&lt;<span class="title">string</span>, <span class="title">_Method</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">A</span> <span class="title">extends</span> <span class="title">_ActionsTree</span></span></span><br><span class="line"><span class="function">&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  $id: Id,</span></span></span><br><span class="line"><span class="function"><span class="params">  setup: () =&gt; SS,</span></span></span><br><span class="line"><span class="function"><span class="params">  options:</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineSetupStoreOptions&lt;Id, S, G, A&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineStoreOptions&lt;Id, S, G, A&gt; = &#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pinia: Pinia,</span></span></span><br><span class="line"><span class="function"><span class="params">  hot?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  isOptionsStore?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Store</span>&lt;<span class="title">Id</span>, <span class="title">S</span>, <span class="title">G</span>, <span class="title">A</span>&gt; </span>&#123;</span><br><span class="line"><span class="comment">// internal state</span></span><br><span class="line"><span class="keyword">let</span> isListening: <span class="built_in">boolean</span> <span class="comment">// set to true at the end</span></span><br><span class="line"><span class="keyword">let</span> isSyncListening: <span class="built_in">boolean</span> <span class="comment">// set to true at the end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// å¯¹å¤–æš´éœ²çš„storeå†…å®¹</span></span><br><span class="line"><span class="keyword">const</span> partialStore = &#123;</span><br><span class="line"> _p: pinia,</span><br><span class="line"> <span class="comment">// _s: scope,</span></span><br><span class="line"> $id,</span><br><span class="line"> <span class="comment">// è°ƒç”¨$onActionä¼šå°†å›è°ƒåŠ å…¥åˆ°actionSubscriptionsä¸­,è°ƒç”¨wrapActionå†…ä¼šè§¦å‘å›è°ƒ</span></span><br><span class="line"> $onAction: addSubscription.bind(<span class="literal">null</span>, actionSubscriptions),</span><br><span class="line"> $patch,</span><br><span class="line"> $reset,</span><br><span class="line"> $subscribe(callback, options = &#123;&#125;) &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨è€…è°ƒç”¨åå°†è®¢é˜…å›è°ƒæ·»åŠ è¿›subscriptions</span></span><br><span class="line"><span class="keyword">const</span> removeSubscription = addSubscription(</span><br><span class="line">  subscriptions,</span><br><span class="line">  callback,</span><br><span class="line">  options.detached,</span><br><span class="line">  () =&gt; stopWatcher()</span><br><span class="line">)</span><br><span class="line">      <span class="comment">// é€šè¿‡watchç›‘å¬store.stateç›´æ¥ä¿®æ”¹</span></span><br><span class="line"><span class="keyword">const</span> stopWatcher = scope.run(<span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line"> watch(</span><br><span class="line">   () =&gt; pinia.state.value[$id] <span class="keyword">as</span> UnwrapRef&lt;S&gt;,</span><br><span class="line">   (state) =&gt; &#123;</span><br><span class="line">     <span class="comment">// flushé»˜è®¤ä¸º'pre',è€Œåœ¨è°ƒç”¨$patchæ—¶isListeningä¼šè¢«è®¾ç½®ä¸ºfalse,æ‰€ä»¥ä¸ä¼šè§¦å‘$patchä¿®æ”¹stateçš„ç›‘å¬å›è°ƒ</span></span><br><span class="line">     <span class="comment">// ä½†å¯¹äºstore.stateç›´æ¥ä¿®æ”¹çš„æƒ…å†µï¼Œstoreåœ¨åˆ›å»ºå®ŒæˆåisSyncListeningå’ŒisListeningéƒ½ä¼šå˜æˆtrueï¼Œæ‰€ä»¥èƒ½å¤Ÿç›‘å¬</span></span><br><span class="line">     <span class="keyword">if</span> (options.flush === <span class="string">'sync'</span> ? isSyncListening : isListening) &#123;</span><br><span class="line">       callback(</span><br><span class="line">         &#123;</span><br><span class="line">           storeId: $id,</span><br><span class="line">           <span class="keyword">type</span>: MutationType.direct, <span class="comment">// typeä¸ºdirectç›´æ¥ä¿®æ”¹</span></span><br><span class="line">           events: debuggerEvents <span class="keyword">as</span> DebuggerEvent,</span><br><span class="line">         &#125;,</span><br><span class="line">         state</span><br><span class="line">       )</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;,</span><br><span class="line">   assign(&#123;&#125;, $subscribeOptions, options)</span><br><span class="line"> )</span><br><span class="line">)!</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> removeSubscription</span><br><span class="line"> &#125;,</span><br><span class="line"> $dispose,</span><br><span class="line">&#125; <span class="keyword">as</span> _StoreWithState&lt;Id, S, G, A&gt;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•´ä¸ªstoreåˆ›å»ºç»“æŸåå°†ä¸¤ä¸ªç›‘å¬æ ‡è¯†ä¸ºtrue,æ„å‘³ç€storeåˆ›å»ºå®Œæˆ,å¯ä»¥è¿›è¡Œç›‘å¬è®¢é˜…æ“ä½œ</span></span><br><span class="line">isListening = <span class="literal">true</span></span><br><span class="line">isSyncListening = <span class="literal">true</span></span><br><span class="line"><span class="keyword">return</span> store</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h3 id="patchä¿®æ”¹"><a href="#patchä¿®æ”¹" class="headerlink" title="$patchä¿®æ”¹"></a>$patchä¿®æ”¹</h3></li>
</ul>
<p>$patchç”¨äºæ‰¹é‡ä¿®æ”¹stateï¼Œå†…éƒ¨ä¸»è¦é€šè¿‡ä¸¤ä¸ªæ ‡è¯†ä½çš„ä¿®æ”¹ï¼Œä¸è§¦å‘<a href="https://so.csdn.net/so/search?q=watch%E7%9B%91%E5%90%AC&spm=1001.2101.3001.7020" target="_blank" rel="noopener">watchç›‘å¬</a>å›è°ƒ</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSetupStore</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">Id</span> <span class="title">extends</span> <span class="title">string</span>,</span></span><br><span class="line"><span class="function">  <span class="title">SS</span> <span class="title">extends</span> <span class="title">Record</span>&lt;<span class="title">any</span>, <span class="title">unknown</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">S</span> <span class="title">extends</span> <span class="title">StateTree</span>,</span></span><br><span class="line"><span class="function">  <span class="title">G</span> <span class="title">extends</span> <span class="title">Record</span>&lt;<span class="title">string</span>, <span class="title">_Method</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">A</span> <span class="title">extends</span> <span class="title">_ActionsTree</span></span></span><br><span class="line"><span class="function">&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  $id: Id,</span></span></span><br><span class="line"><span class="function"><span class="params">  setup: () =&gt; SS,</span></span></span><br><span class="line"><span class="function"><span class="params">  options:</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineSetupStoreOptions&lt;Id, S, G, A&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineStoreOptions&lt;Id, S, G, A&gt; = &#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pinia: Pinia,</span></span></span><br><span class="line"><span class="function"><span class="params">  hot?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  isOptionsStore?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Store</span>&lt;<span class="title">Id</span>, <span class="title">S</span>, <span class="title">G</span>, <span class="title">A</span>&gt; </span>&#123;</span><br><span class="line"><span class="comment">// internal state</span></span><br><span class="line"><span class="keyword">let</span> isListening: <span class="built_in">boolean</span> <span class="comment">// set to true at the end</span></span><br><span class="line"><span class="keyword">let</span> isSyncListening: <span class="built_in">boolean</span> <span class="comment">// set to true at the end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">$patch</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params"> partialStateOrMutator:</span></span></span><br><span class="line"><span class="function"><span class="params">   | _DeepPartial&lt;UnwrapRef&lt;S&gt;&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">   | ((state: UnwrapRef&lt;S&gt;) =&gt; <span class="built_in">void</span>)</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line"> <span class="comment">// è®¢é˜…$patchæ“ä½œtype</span></span><br><span class="line"> <span class="keyword">let</span> subscriptionMutation: SubscriptionCallbackMutation&lt;S&gt;</span><br><span class="line"> <span class="comment">// é¿å…æ‰¹é‡ä¿®æ”¹è§¦å‘$subscribe</span></span><br><span class="line"> isListening = isSyncListening = <span class="literal">false</span></span><br><span class="line"> </span><br><span class="line"> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">   debuggerEvents = []</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// å…¼å®¹$patchä¼ é€’å‡½æ•°ã€å¯¹è±¡è°ƒç”¨çš„ä¸¤ç§è°ƒç”¨æ–¹å¼</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">typeof</span> partialStateOrMutator === <span class="string">'function'</span>) &#123;</span><br><span class="line">   partialStateOrMutator(pinia.state.value[$id] <span class="keyword">as</span> UnwrapRef&lt;S&gt;)</span><br><span class="line">   subscriptionMutation = &#123;</span><br><span class="line">     <span class="keyword">type</span>: MutationType.patchFunction,  <span class="comment">// typeç±»å‹</span></span><br><span class="line">     storeId: $id,</span><br><span class="line">     events: debuggerEvents <span class="keyword">as</span> DebuggerEvent[],</span><br><span class="line">   &#125;</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="comment">// $patchä¼ é€’å¯¹è±¡èµ°åˆå¹¶æµç¨‹</span></span><br><span class="line">   mergeReactiveObjects(pinia.state.value[$id], partialStateOrMutator)</span><br><span class="line">   subscriptionMutation = &#123;</span><br><span class="line">     <span class="keyword">type</span>: MutationType.patchObject, <span class="comment">// typeç±»å‹</span></span><br><span class="line">     payload: partialStateOrMutator,</span><br><span class="line">     storeId: $id,</span><br><span class="line">     events: debuggerEvents <span class="keyword">as</span> DebuggerEvent[],</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">const</span> myListenerId = (activeListener = Symbol())</span><br><span class="line"> <span class="comment">// å¯¹äºå¼‚æ­¥ä¿®æ”¹æƒ…å†µï¼Œå¼‚æ­¥è¿˜åŸisListening,è®©$subscribeä¸ä¼šç›‘å¬é€šè¿‡$patchä¿®æ”¹state</span></span><br><span class="line"> nextTick().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (activeListener === myListenerId) &#123;</span><br><span class="line">     isListening = <span class="literal">true</span></span><br><span class="line">   &#125;</span><br><span class="line"> &#125;)</span><br><span class="line"> isSyncListening = <span class="literal">true</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">// æ‰‹åŠ¨è§¦å‘è®¢é˜…,å®ç°é€šè¿‡$patchæ‰¹é‡ä¿®æ”¹stateåªè§¦å‘ä¸€æ¬¡è®¢é˜…å›è°ƒ</span></span><br><span class="line"> triggerSubscriptions(</span><br><span class="line">   subscriptions,</span><br><span class="line">   subscriptionMutation,</span><br><span class="line">   pinia.state.value[$id] <span class="keyword">as</span> UnwrapRef&lt;S&gt;</span><br><span class="line"> )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•´ä¸ªstoreåˆ›å»ºç»“æŸåå°†ä¸¤ä¸ªç›‘å¬æ ‡è¯†ä¸ºtrue,æ„å‘³ç€storeåˆ›å»ºå®Œæˆ,å¯ä»¥è¿›è¡Œç›‘å¬è®¢é˜…æ“ä½œ</span></span><br><span class="line">isListening = <span class="literal">true</span></span><br><span class="line">isSyncListening = <span class="literal">true</span></span><br><span class="line"><span class="keyword">return</span> store</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="store-API"><a href="#store-API" class="headerlink" title="store API"></a>store API</h2><ul>
<li><h2 id="reset"><a href="#reset" class="headerlink" title="$reset"></a>$reset</h2></li>
</ul>
<p>å¯¹äºoptions storeæä¾›çš„è¿˜åŸåˆå§‹çŠ¶æ€çš„API</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// options store</span></span><br><span class="line">store.$reset = <span class="function"><span class="keyword">function</span> <span class="title">$reset</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> newState = state ? state() : &#123;&#125;  <span class="comment">// stateä¸ºoptionsä¸­çš„state</span></span><br><span class="line">  <span class="comment">// é€šè¿‡$patchæ‰¹é‡ä¿®æ”¹</span></span><br><span class="line">  <span class="keyword">this</span>.$patch(<span class="function">(<span class="params">$state</span>) =&gt;</span> &#123;</span><br><span class="line">    assign($state, newState)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// setup store</span></span><br><span class="line"><span class="keyword">const</span> $reset = __DEV__ <span class="comment">// å¼€å‘ç¯å¢ƒä¸‹ä¼šæŠ¥é”™</span></span><br><span class="line">  ? <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">`ğŸ: Store "<span class="subst">$&#123;$id&#125;</span>" is built using the setup syntax and does not implement $reset().`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  : noop</span><br></pre></td></tr></table></figure>

<ul>
<li><h2 id="dispose"><a href="#dispose" class="headerlink" title="$dispose"></a>$dispose</h2></li>
</ul>
<p>å¸è½½storeçš„API</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¸è½½store</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">$dispose</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  scope.stop() <span class="comment">//å¸è½½storeçš„scope effect</span></span><br><span class="line">  subscriptions = []</span><br><span class="line">  actionSubscriptions = []</span><br><span class="line">  pinia._s.delete($id) <span class="comment">// ä»piniaä¸Šåˆ é™¤æ‰å¯¹åº”çš„store</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="storeToRefsè§£æ„store"><a href="#storeToRefsè§£æ„store" class="headerlink" title="storeToRefsè§£æ„store"></a>storeToRefsè§£æ„store</h2><p>é€šè¿‡storeToRefsä½¿å¾—è§£æ„storeä¹Ÿä¸ä¼šä¸¢å¤±å“åº”å¼</p>
<ul>
<li>åŸºæœ¬ä½¿ç”¨</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> defineComponent(&#123;</span><br><span class="line">  setup() &#123;</span><br><span class="line">    <span class="keyword">const</span> store = useCounterStore()</span><br><span class="line">    <span class="comment">// âŒ è¿™å°†æ— æ³•ç”Ÿæ•ˆï¼Œå› ä¸ºå®ƒç ´åäº†å“åº”æ€§</span></span><br><span class="line">    <span class="comment">// è¿™ä¸ä» `props` ä¸­è§£æ„æ˜¯ä¸€æ ·çš„ã€‚</span></span><br><span class="line">    <span class="keyword">const</span> &#123; name, doubleCount &#125; = store</span><br><span class="line"></span><br><span class="line">    name <span class="comment">// "eduardo"</span></span><br><span class="line">    doubleCount <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// å§‹ç»ˆæ˜¯ "eduardo"</span></span><br><span class="line">      name,</span><br><span class="line">      <span class="comment">// å§‹ç»ˆæ˜¯ 2</span></span><br><span class="line">      doubleCount,</span><br><span class="line">      <span class="comment">// è¿™ä¸ªå°†æ˜¯å“åº”å¼çš„</span></span><br><span class="line">      doubleValue: computed(<span class="function"><span class="params">()</span> =&gt;</span> store.doubleCount),</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡storeToRefsè°ƒç”¨</span></span><br><span class="line"><span class="keyword">import</span> &#123; storeToRefs &#125; <span class="keyword">from</span> <span class="string">'pinia'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> defineComponent(&#123;</span><br><span class="line">  setup() &#123;</span><br><span class="line">    <span class="keyword">const</span> store = useCounterStore()</span><br><span class="line">    <span class="comment">// `name` and `doubleCount` éƒ½æ˜¯å“åº”å¼ refs</span></span><br><span class="line">    <span class="comment">// è¿™ä¹Ÿå°†ä¸ºç”±æ’ä»¶æ·»åŠ çš„å±æ€§åˆ›å»º refs</span></span><br><span class="line">    <span class="comment">// åŒæ—¶ä¼šè·³è¿‡ä»»ä½• action æˆ–éå“åº”å¼(é ref/å“åº”å¼)å±æ€§</span></span><br><span class="line">    <span class="keyword">const</span> &#123; name, doubleCount &#125; = storeToRefs(store)</span><br><span class="line">    <span class="comment">// åä¸º increment çš„ action å¯ä»¥ç›´æ¥æå–</span></span><br><span class="line">    <span class="keyword">const</span> &#123; increment &#125; = store</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      name,</span><br><span class="line">      doubleCount,</span><br><span class="line">      increment,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>storeToRefs<ul>
<li>ç±»ä¼¼toRefsï¼Œä½†ä¼šè·³è¿‡æ–¹æ³•å’Œéå“åº”å¼å±æ€§</li>
</ul>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// storeToRefs.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">storeToRefs</span>&lt;<span class="title">SS</span> <span class="title">extends</span> <span class="title">StoreGeneric</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  store: SS</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">ToRefs</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">StoreState</span>&lt;<span class="title">SS</span>&gt; &amp; <span class="title">StoreGetters</span>&lt;<span class="title">SS</span>&gt; &amp; <span class="title">PiniaCustomStateProperties</span>&lt;<span class="title">StoreState</span>&lt;<span class="title">SS</span>&gt;&gt;</span></span><br><span class="line"><span class="function">&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isVue2) &#123;</span><br><span class="line">    <span class="comment">// @ts-expect-error: toRefs include methods and others</span></span><br><span class="line">    <span class="keyword">return</span> toRefs(store) <span class="comment">// vue2 ç‰ˆæœ¬ç›´æ¥all in ref</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  </span><br><span class="line">    store = toRaw(store) <span class="comment">// æ‹¿åˆ°storeåŸå§‹å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> refs = &#123;&#125; <span class="keyword">as</span> ToRefs&lt;</span><br><span class="line">      StoreState&lt;SS&gt; &amp;</span><br><span class="line">        StoreGetters&lt;SS&gt; &amp;</span><br><span class="line">        PiniaCustomStateProperties&lt;StoreState&lt;SS&gt;&gt;</span><br><span class="line">    &gt;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> store) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = store[key]</span><br><span class="line">      <span class="comment">// åªè½¬æ¢refã€reactiveå±æ€§</span></span><br><span class="line">      <span class="keyword">if</span> (isRef(value) || isReactive(value)) &#123;</span><br><span class="line">        <span class="comment">// @ts-expect-error: the key is state or getter</span></span><br><span class="line">        refs[key] =</span><br><span class="line">          <span class="comment">// ---</span></span><br><span class="line">          toRef(store, key)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> refs</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="mapç³»åˆ—è¾…åŠ©å‡½æ•°"><a href="#mapç³»åˆ—è¾…åŠ©å‡½æ•°" class="headerlink" title="mapç³»åˆ—è¾…åŠ©å‡½æ•°"></a>mapç³»åˆ—è¾…åŠ©å‡½æ•°</h2><ul>
<li><h2 id="mapState"><a href="#mapState" class="headerlink" title="mapState"></a>mapState</h2></li>
</ul>
<p>åŸºæœ¬ä½¿ç”¨</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  computed: &#123;</span><br><span class="line">    <span class="comment">// å¯ä»¥è®¿é—®ç»„ä»¶ä¸­çš„ this.count</span></span><br><span class="line">    <span class="comment">// ä¸ä» store.count ä¸­è¯»å–çš„æ•°æ®ç›¸åŒ</span></span><br><span class="line">    ...mapState(useCounterStore, [<span class="string">'count'</span>])</span><br><span class="line">    <span class="comment">// ä¸ä¸Šè¿°ç›¸åŒï¼Œä½†å°†å…¶æ³¨å†Œä¸º this.myOwnName</span></span><br><span class="line">    ...mapState(useCounterStore, &#123;</span><br><span class="line">      myOwnName: <span class="string">'count'</span>,</span><br><span class="line">      <span class="comment">// ä½ ä¹Ÿå¯ä»¥å†™ä¸€ä¸ªå‡½æ•°æ¥è·å¾—å¯¹ store çš„è®¿é—®æƒ</span></span><br><span class="line">      double: <span class="function"><span class="params">store</span> =&gt;</span> store.count * <span class="number">2</span>,</span><br><span class="line">      <span class="comment">// å®ƒå¯ä»¥è®¿é—® `this`ï¼Œä½†å®ƒæ²¡æœ‰æ ‡æ³¨ç±»å‹...</span></span><br><span class="line">      magicValue(store) &#123;</span><br><span class="line">        <span class="keyword">return</span> store.someGetter + <span class="keyword">this</span>.count + <span class="keyword">this</span>.double</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mapState</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mapHelpers.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mapState</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">Id</span> <span class="title">extends</span> <span class="title">string</span>,</span></span><br><span class="line"><span class="function">  <span class="title">S</span> <span class="title">extends</span> <span class="title">StateTree</span>,</span></span><br><span class="line"><span class="function">  <span class="title">G</span> <span class="title">extends</span> <span class="title">_GettersTree</span>&lt;<span class="title">S</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">A</span></span></span><br><span class="line"><span class="function">&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  useStore: StoreDefinition&lt;Id, S, G, A&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  keysOrMapper: <span class="built_in">any</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">_MapStateReturn</span>&lt;<span class="title">S</span>, <span class="title">G</span>&gt; | <span class="title">_MapStateObjectReturn</span>&lt;<span class="title">Id</span>, <span class="title">S</span>, <span class="title">G</span>, <span class="title">A</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// è¿”å›ä¸€ä¸ªå¯¹è±¡ä½¿å¾—èƒ½å¤Ÿæ”¾åˆ°ç»„ä»¶çš„computedå±æ€§ä¸Š</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Array</span>.isArray(keysOrMapper)</span><br><span class="line">    ? keysOrMapper.reduce(<span class="function">(<span class="params">reduced, key</span>) =&gt;</span> &#123;</span><br><span class="line">        reduced[key] = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="keyword">this</span>: ComponentPublicInstance</span>) </span>&#123;</span><br><span class="line">          <span class="comment">// é€šè¿‡useStoreï¼Œå› ä¸ºstoreå·²ç»åˆ›å»ºï¼Œæ‰€ä»¥å†…éƒ¨ä¼šç›´æ¥é€šè¿‡pinia._s.get(id)ç›´æ¥è¿”å›storeè€Œä¸ä¼šé‡æ–°åˆ›å»º</span></span><br><span class="line">          <span class="keyword">return</span> useStore(<span class="keyword">this</span>.$pinia)[key]</span><br><span class="line">        &#125; <span class="keyword">as</span> () =&gt; <span class="built_in">any</span></span><br><span class="line">        <span class="keyword">return</span> reduced</span><br><span class="line">      &#125;, &#123;&#125; <span class="keyword">as</span> _MapStateReturn&lt;S, G&gt;)</span><br><span class="line">    : <span class="built_in">Object</span>.keys(keysOrMapper).reduce(<span class="function">(<span class="params">reduced, key: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// @ts-expect-error</span></span><br><span class="line">        reduced[key] = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="keyword">this</span>: ComponentPublicInstance</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">const</span> store = useStore(<span class="keyword">this</span>.$pinia)</span><br><span class="line">          <span class="keyword">const</span> storeKey = keysOrMapper[key]</span><br><span class="line">          <span class="comment">// for some reason TS is unable to infer the type of storeKey to be a</span></span><br><span class="line">          <span class="comment">// function</span></span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">typeof</span> storeKey === <span class="string">'function'</span></span><br><span class="line">            ? <span class="function">(<span class="params">storeKey <span class="keyword">as</span> (<span class="params">store: Store&lt;Id, S, G, A&gt;</span>) =&gt; <span class="built_in">any</span></span>).<span class="params">call</span>(<span class="params"><span class="keyword">this</span>, store</span>)</span></span><br><span class="line"><span class="function">            : <span class="params">store</span>[<span class="params">storeKey</span>]</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">        <span class="params">return</span> <span class="params">reduced</span></span></span><br><span class="line"><span class="function">      &#125;, &#123;&#125; <span class="params">as</span> _<span class="params">MapStateObjectReturn</span>&lt;<span class="params">Id</span>, <span class="params">S</span>, <span class="params">G</span>, <span class="params">A</span>&gt;)</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h2 id="mapGetters"><a href="#mapGetters" class="headerlink" title="mapGetters"></a>mapGetters</h2></li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mapGetters = mapState <span class="comment">//ğŸ‘</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h2 id="mapActions"><a href="#mapActions" class="headerlink" title="mapActions"></a>mapActions</h2></li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mapActions</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">Id</span> <span class="title">extends</span> <span class="title">string</span>,</span></span><br><span class="line"><span class="function">  <span class="title">S</span> <span class="title">extends</span> <span class="title">StateTree</span>,</span></span><br><span class="line"><span class="function">  <span class="title">G</span> <span class="title">extends</span> <span class="title">_GettersTree</span>&lt;<span class="title">S</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">A</span>,</span></span><br><span class="line"><span class="function">  <span class="title">KeyMapper</span> <span class="title">extends</span> <span class="title">Record</span>&lt;<span class="title">string</span>, <span class="title">keyof</span> <span class="title">A</span>&gt;</span></span><br><span class="line"><span class="function">&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  useStore: StoreDefinition&lt;Id, S, G, A&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  keysOrMapper: <span class="built_in">Array</span>&lt;keyof A&gt; | KeyMapper</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">_MapActionsReturn</span>&lt;<span class="title">A</span>&gt; | <span class="title">_MapActionsObjectReturn</span>&lt;<span class="title">A</span>, <span class="title">KeyMapper</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Array</span>.isArray(keysOrMapper)</span><br><span class="line">    ? keysOrMapper.reduce(<span class="function">(<span class="params">reduced, key</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// å’ŒmapStateç±»ä¼¼,é—­åŒ…å­˜äº†ä¸‹thiså’Œå…¶ä»–å‚æ•°</span></span><br><span class="line">        reduced[key] = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">this</span>: ComponentPublicInstance,</span></span></span><br><span class="line"><span class="function"><span class="params">          ...args: <span class="built_in">any</span>[]</span></span></span><br><span class="line"><span class="function"><span class="params">        </span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> useStore(<span class="keyword">this</span>.$pinia)[key](...args)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> reduced</span><br><span class="line">      &#125;, &#123;&#125; <span class="keyword">as</span> _MapActionsReturn&lt;A&gt;)</span><br><span class="line">    : <span class="built_in">Object</span>.keys(keysOrMapper).reduce(<span class="function">(<span class="params">reduced, key: keyof KeyMapper</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// @ts-expect-error</span></span><br><span class="line">        reduced[key] = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">this</span>: ComponentPublicInstance,</span></span></span><br><span class="line"><span class="function"><span class="params">          ...args: <span class="built_in">any</span>[]</span></span></span><br><span class="line"><span class="function"><span class="params">        </span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> useStore(<span class="keyword">this</span>.$pinia)[keysOrMapper[key]](...args)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> reduced</span><br><span class="line">      &#125;, &#123;&#125; <span class="keyword">as</span> _MapActionsObjectReturn&lt;A, KeyMapper&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å’ŒvuexåŒºåˆ«"><a href="#å’ŒvuexåŒºåˆ«" class="headerlink" title="å’ŒvuexåŒºåˆ«"></a>å’ŒvuexåŒºåˆ«</h2><ul>
<li><h2 id="ä¸å†æœ‰åµŒå¥—ç»“æ„çš„æ¨¡å—"><a href="#ä¸å†æœ‰åµŒå¥—ç»“æ„çš„æ¨¡å—" class="headerlink" title="ä¸å†æœ‰åµŒå¥—ç»“æ„çš„æ¨¡å—"></a>ä¸å†æœ‰åµŒå¥—ç»“æ„çš„æ¨¡å—</h2><ul>
<li>çœ‹è¿‡vuexçš„åº”è¯¥çŸ¥é“ï¼Œæ•´ä¸ªvuexå°±æ˜¯ä¸ªåµŒå¥—çš„å¤§å¯¹è±¡ï¼Œä¼šæ ¹æ®å‘½åç©ºé—´ä¸€æ­¥ä¸€æ­¥ä»å¯¹è±¡ä¸­å–å‡ºå†…å®¹ï¼Œä¸è¿‡å†…éƒ¨ä¼šå¸®ä½ æ‹¼æ¥å‘½åç©ºé—´è·¯å¾„ï¼Œå®é™…è°ƒç”¨æ—¶ä¹Ÿè¿˜å¥½</li>
<li>è€Œpiniaä¸å†é€šè¿‡å‘½åç©ºé—´æ¥åµŒå¥—å¯¹è±¡ï¼Œé€šè¿‡pinia._sè¿™ä¸ªMapç»“æ„æ¥å­˜å‚¨åˆ›å»ºçš„storeï¼Œé€šè¿‡pinia.state.value[storeId]æ¥å­˜å‚¨stateï¼Œæ•´ä¸ªå°±æ˜¯ä¸€å¹³çº§çš„ç»“æ„</li>
</ul>
</li>
<li><h2 id="åˆ›å»ºéå¸¸æ–¹ä¾¿ï¼Œå’Œå†™ä¸€ä¸ªhookå‡½æ•°ä¸€æ ·è½»æ¾"><a href="#åˆ›å»ºéå¸¸æ–¹ä¾¿ï¼Œå’Œå†™ä¸€ä¸ªhookå‡½æ•°ä¸€æ ·è½»æ¾" class="headerlink" title="åˆ›å»ºéå¸¸æ–¹ä¾¿ï¼Œå’Œå†™ä¸€ä¸ªhookå‡½æ•°ä¸€æ ·è½»æ¾"></a>åˆ›å»ºéå¸¸æ–¹ä¾¿ï¼Œå’Œå†™ä¸€ä¸ªhookå‡½æ•°ä¸€æ ·è½»æ¾</h2><ul>
<li>è™½ç„¶ä½†æ˜¯ï¼Œæ€»è§‰å¾—vueè¶Šæ¥è¶ŠåƒReactï¼Œç”¨è¿‡hoxçš„åº”è¯¥çŸ¥é“ï¼ŒPiniaçš„ä½¿ç”¨æ–¹å¼å‡ ä¹å’Œhoxä¸€æ¨¡ä¸€æ ·ã€‚ã€‚ã€‚</li>
</ul>
</li>
<li><h2 id="æ— éœ€mutation"><a href="#æ— éœ€mutation" class="headerlink" title="æ— éœ€mutation"></a>æ— éœ€mutation</h2><ul>
<li>è§ä»è§æ™ºå§ï¼Œæœ‰ä¸ªmutationè°ƒç”¨æµç¨‹æ›´è§„èŒƒï¼Œæ²¡æœ‰å°±æ˜¯å‡½æ•°è°ƒç”¨ï¼Œæ— å­¦ä¹ æˆæœ¬</li>
</ul>
</li>
<li><p>æ€»ç»“ä¸€ä¸‹ï¼Œè™½ç„¶å•é¡¹æ•°æ®æµç±»å‹çš„çŠ¶æ€ç®¡ç†åº“ï¼ˆreduxã€vuexï¼‰å…·æœ‰ååˆ†ä¸¥è°¨çš„è°ƒç”¨æ­¥éª¤ï¼Œä½†è¿™ç§å‡½æ•°å¼çš„æ–¹å¼æ‰æ˜¯æœªæ¥ï¼ˆä¸»è¦æ˜¯å¼€å‘çˆ½äº†ã€‚ã€‚ã€‚ï¼‰</p>
</li>
</ul>

        </div>

        


        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue/">Vue</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://summxu.github.io/2023/Piniaä½¿ç”¨å’Œæºç è§£æ/&title=ã€ŠPiniaä½¿ç”¨å’Œæºç è§£æã€‹ â€” å°å…µæ—­æ—­çš„åšå®¢&pic=https://summxu.github.io/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://summxu.github.io/2023/Piniaä½¿ç”¨å’Œæºç è§£æ/&title=ã€ŠPiniaä½¿ç”¨å’Œæºç è§£æã€‹ â€” å°å…µæ—­æ—­çš„åšå®¢&source=å°å…µæ—­æ—­" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://summxu.github.io/2023/Piniaä½¿ç”¨å’Œæºç è§£æ/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€ŠPiniaä½¿ç”¨å’Œæºç è§£æã€‹ â€” å°å…µæ—­æ—­çš„åšå®¢&url=https://summxu.github.io/2023/Piniaä½¿ç”¨å’Œæºç è§£æ/&via=https://summxu.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://summxu.github.io/2023/Piniaä½¿ç”¨å’Œæºç è§£æ/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2023/ç°ä»£CSSè§£å†³æ–¹æ¡ˆï¼šåŸç”Ÿæ”¯æŒçš„ä¸‰è§’å‡½æ•°/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">ç°ä»£CSSè§£å†³æ–¹æ¡ˆï¼šåŸç”Ÿæ”¯æŒçš„ä¸‰è§’å‡½æ•°</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2023/Vue3å“åº”å¼å±æ€§Reactiveå’ŒRef/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Vue3å“åº”å¼å±æ€§Reactiveå’ŒRef</h4>
      </a>
    </div>
  
</nav>



    




















</article>



</div>

        <footer class="footer">
  <div class="top" style="display: none;">
    
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        è®¿å®¢æ•°ï¼š<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        è®¿é—®é‡ï¼š<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


    <p>
      <!-- 
      <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i
            class="icon icon-lg icon-rss"></i></a></span>
       -->
      <span>åšå®¢å†…å®¹éµå¾ª <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">çŸ¥è¯†å…±äº« ç½²å - éå•†ä¸šæ€§ - ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…åè®®</a></span>
    </p>
  </div>
  <div class="bottom">
    <p><span>summxu &copy;
        2017 -
        2023</span>
      <span>
        
        Power by Hexo
      </span>
    </p>
  </div>
</footer>
    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://summxu.github.io/2023/Piniaä½¿ç”¨å’Œæºç è§£æ/&title=ã€ŠPiniaä½¿ç”¨å’Œæºç è§£æã€‹ â€” å°å…µæ—­æ—­çš„åšå®¢&pic=https://summxu.github.io/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://summxu.github.io/2023/Piniaä½¿ç”¨å’Œæºç è§£æ/&title=ã€ŠPiniaä½¿ç”¨å’Œæºç è§£æã€‹ â€” å°å…µæ—­æ—­çš„åšå®¢&source=å°å…µæ—­æ—­" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://summxu.github.io/2023/Piniaä½¿ç”¨å’Œæºç è§£æ/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€ŠPiniaä½¿ç”¨å’Œæºç è§£æã€‹ â€” å°å…µæ—­æ—­çš„åšå®¢&url=https://summxu.github.io/2023/Piniaä½¿ç”¨å’Œæºç è§£æ/&via=https://summxu.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://summxu.github.io/2023/Piniaä½¿ç”¨å’Œæºç è§£æ/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>æ‰«ä¸€æ‰«åˆ†äº«åˆ°å¾®ä¿¡</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACJUlEQVR42u3aQY7CMAwF0Ln/pZktEmr5tgGp7stqVDpJX5GMY+fvLx6Pp/F85fXTo/E6W7LKhwcGBsZlGcnyyQLVe85fSv5sGBgY92EcLXl0Tx6C84dL1j28joGBgXH6EPP0MX99GBgYGFXGZEtc3SpjYGBg5OlaMml1hvPX9+G9OAYGxgUZval/8/dX+hsYGBiXYjyKoxegk8d6DAYGBsZuxmSZatD8VKP08E4MDIyljLzc30slzx8rZ7y5goGBsZrRA+TFr6TB2WuIHn4nGBgY6xjnAa4XfKsHKfL7o+8BAwNjNSMPcJMly78Gk2MWGBgYixi9ctikAFd9ZW+KcRgYGKsZ1RStV4ZLZiuE116CiIGBcXFGtbjWSwR7G+O8qYCBgbGbMZl0Hnbzmd+0IjAwMJYyek3EeWuz+hLLPVgMDIxFjHmBbNKwrKae5TNuGBgYKxj5YYtk5Alfdc43wRoDA+MGjF57YNJ0nLQfokIbBgbGIkY+6WiBYok/bzlgYGDcmdGcqBU688SxcGYEAwNjKaNa3O+1E3rJYvQqMTAwbsaoHvDKD2HkiWb+vxgYGLsZk9J/Hlh7SWSh5YCBgbGakY9yW7H4iNUfgCYGAwPjsozeEYpvHMWoUjEwMO7GqLYB8kLbpPRf3spiYGBgFBsJ1QMcvWQUAwMD4/db02pJDgMD4z6MvBnQK+jnhy16wR0DA2M347N5Vy/s9pqXGBgYN2D8A6Jzf61FEfdzAAAAAElFTkSuQmCC" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };

</script>

<script src="/js/main.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.js?v=1.7.2" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</body>
</html>
