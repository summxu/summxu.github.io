<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>Pinia使用和源码解析</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="JavaScript,Vue">
    <div style="display:none;"><img src="/img/avatar.jpg"></div>
    <meta property="og:image" content="https://summxu.github.io/img/avatar.jpg">
    <meta name="description" content="创建pinia基本使用 123456789101112131415const pinia = createPinia()const app = createApp(App)app.use(pinia)app.mount(&apos;#app&apos;)//vue2 使用import &amp;#123; createPinia, PiniaVuePlugin &amp;#125; from &apos;pinia&apos;Vue.use(Pinia">
<meta name="keywords" content="JavaScript,Vue">
<meta property="og:type" content="article">
<meta property="og:title" content="Pinia使用和源码解析">
<meta property="og:url" content="https://summxu.github.io/2023/Pinia使用和源码解析/index.html">
<meta property="og:site_name" content="小兵旭旭的博客">
<meta property="og:description" content="创建pinia基本使用 123456789101112131415const pinia = createPinia()const app = createApp(App)app.use(pinia)app.mount(&apos;#app&apos;)//vue2 使用import &amp;#123; createPinia, PiniaVuePlugin &amp;#125; from &apos;pinia&apos;Vue.use(Pinia">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2023-11-28T09:16:56.452Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Pinia使用和源码解析">
<meta name="twitter:description" content="创建pinia基本使用 123456789101112131415const pinia = createPinia()const app = createApp(App)app.use(pinia)app.mount(&apos;#app&apos;)//vue2 使用import &amp;#123; createPinia, PiniaVuePlugin &amp;#125; from &apos;pinia&apos;Vue.use(Pinia">
    
        <link rel="alternate" type="application/atom+xml" title="小兵旭旭的博客" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu"  >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">summxu</h5>
          <a href="mailto:chenxu4012@foxmail.com" title="chenxu4012@foxmail.com" class="mail">chenxu4012@foxmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-align-right"></i>
                时间线
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags/JavaScript"  >
                <i class="icon icon-lg icon-star"></i>
                分类标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about"  >
                <i class="icon icon-lg icon-grav"></i>
                这是我
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/summxu" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://weibo.com/u/1938786603" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/atom.xml" target="_blank" >
                <i class="icon icon-lg icon-rss-square"></i>
                Rss
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Pinia使用和源码解析</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Pinia使用和源码解析</h1>
        <h5 class="subtitle">
            
                <time datetime="2023-06-26T01:36:37.000Z" itemprop="datePublished" class="page-time">
  2023-06-26
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#创建pinia"><span class="post-toc-number">1.</span> <span class="post-toc-text">创建pinia</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#createPinia"><span class="post-toc-number">2.</span> <span class="post-toc-text">createPinia</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#设置、获取pinia"><span class="post-toc-number">3.</span> <span class="post-toc-text">设置、获取pinia</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#兼容vue2"><span class="post-toc-number">4.</span> <span class="post-toc-text">兼容vue2</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#创建store"><span class="post-toc-number">5.</span> <span class="post-toc-text">创建store</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#defineStore"><span class="post-toc-number">6.</span> <span class="post-toc-text">defineStore</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#createSetupStore"><span class="post-toc-number">7.</span> <span class="post-toc-text">createSetupStore</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#响应式处理store"><span class="post-toc-number">7.1.</span> <span class="post-toc-text">响应式处理store</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#处理setup返回的内容"><span class="post-toc-number">7.2.</span> <span class="post-toc-text">处理setup返回的内容</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#同步setup返回内容和pinia-state"><span class="post-toc-number">7.3.</span> <span class="post-toc-text">同步setup返回内容和pinia.state</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#处理action"><span class="post-toc-number">7.4.</span> <span class="post-toc-text">处理action</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#处理store合并setup"><span class="post-toc-number">7.5.</span> <span class="post-toc-text">处理store合并setup</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#createOptionsStore"><span class="post-toc-number">8.</span> <span class="post-toc-text">createOptionsStore</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#订阅发布"><span class="post-toc-number">9.</span> <span class="post-toc-text">订阅发布</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#发布订阅模式"><span class="post-toc-number">10.</span> <span class="post-toc-text">发布订阅模式</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#监听action"><span class="post-toc-number">11.</span> <span class="post-toc-text">监听action</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#通过-onAction添加订阅"><span class="post-toc-number">11.1.</span> <span class="post-toc-text">通过$onAction添加订阅</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#通过wrapAction进行发布"><span class="post-toc-number">11.2.</span> <span class="post-toc-text">通过wrapAction进行发布</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#监听修改state"><span class="post-toc-number">12.</span> <span class="post-toc-text">监听修改state</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#直接修改state"><span class="post-toc-number">12.1.</span> <span class="post-toc-text">直接修改state</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#patch修改"><span class="post-toc-number">12.2.</span> <span class="post-toc-text">$patch修改</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#store-API"><span class="post-toc-number">13.</span> <span class="post-toc-text">store API</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#reset"><span class="post-toc-number">14.</span> <span class="post-toc-text">$reset</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#dispose"><span class="post-toc-number">15.</span> <span class="post-toc-text">$dispose</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#storeToRefs解构store"><span class="post-toc-number">16.</span> <span class="post-toc-text">storeToRefs解构store</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#map系列辅助函数"><span class="post-toc-number">17.</span> <span class="post-toc-text">map系列辅助函数</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#mapState"><span class="post-toc-number">18.</span> <span class="post-toc-text">mapState</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#mapGetters"><span class="post-toc-number">19.</span> <span class="post-toc-text">mapGetters</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#mapActions"><span class="post-toc-number">20.</span> <span class="post-toc-text">mapActions</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#和vuex区别"><span class="post-toc-number">21.</span> <span class="post-toc-text">和vuex区别</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#不再有嵌套结构的模块"><span class="post-toc-number">22.</span> <span class="post-toc-text">不再有嵌套结构的模块</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#创建非常方便，和写一个hook函数一样轻松"><span class="post-toc-number">23.</span> <span class="post-toc-text">创建非常方便，和写一个hook函数一样轻松</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#无需mutation"><span class="post-toc-number">24.</span> <span class="post-toc-text">无需mutation</span></a></li></ol>
        </nav>
    </aside>


<article id="post-2023/Pinia使用和源码解析"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Pinia使用和源码解析</h1>
        <div class="post-meta">
            <time class="post-time" title="2023-06-26 09:36:37" datetime="2023-06-26T01:36:37.000Z"  itemprop="datePublished">2023-06-26</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="创建pinia"><a href="#创建pinia" class="headerlink" title="创建pinia"></a>创建pinia</h2><p>基本使用</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> pinia = createPinia()</span><br><span class="line"><span class="keyword">const</span> app = createApp(App)</span><br><span class="line"></span><br><span class="line">app.use(pinia)</span><br><span class="line">app.mount(<span class="string">'#app'</span>)</span><br><span class="line"><span class="comment">//vue2 使用</span></span><br><span class="line"><span class="keyword">import</span> &#123; createPinia, PiniaVuePlugin &#125; <span class="keyword">from</span> <span class="string">'pinia'</span></span><br><span class="line"></span><br><span class="line">Vue.use(PiniaVuePlugin)</span><br><span class="line"><span class="keyword">const</span> pinia = createPinia()</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>, </span><br><span class="line">  pinia,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="createPinia"><a href="#createPinia" class="headerlink" title="createPinia"></a>createPinia</h2><ul>
<li>将pinia绑定到实例上</li>
<li>创建一个scope用来保存之后创建的每一个store的state，也可以直接通过pinia.state.value[storeId]直接设置state</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ceatePinia.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createPinia</span>(<span class="params"></span>): <span class="title">Pinia</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 创建个scope effct来单独管理state</span></span><br><span class="line">  <span class="keyword">const</span> scope = effectScope(<span class="literal">true</span>)</span><br><span class="line">  <span class="comment">// 通过pinia.state.value[storeId]会保存之后创建的store的state</span></span><br><span class="line">  <span class="keyword">const</span> state = scope.run&lt;Ref&lt;Record&lt;<span class="built_in">string</span>, StateTree&gt;&gt;&gt;<span class="function">(<span class="params">(<span class="params"></span>) =&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    ref&lt;Record&lt;<span class="built_in">string</span>, StateTree&gt;&gt;(<span class="params">&#123;&#125;</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>)!</span></span><br><span class="line"><span class="function">  </span></span><br><span class="line"><span class="function">  // 插件相关</span></span><br><span class="line"><span class="function">  <span class="params">let</span> _<span class="params">p</span>: <span class="params">Pinia</span>['_<span class="params">p</span>'] = []</span></span><br><span class="line"><span class="function">  // <span class="params">plugins</span> <span class="params">added</span> <span class="params">before</span> <span class="params">calling</span> <span class="params">app</span>.<span class="params">use</span>(<span class="params">pinia</span>)</span></span><br><span class="line"><span class="function">  <span class="params">let</span> <span class="params">toBeInstalled</span>: <span class="params">PiniaPlugin</span>[] = []</span></span><br><span class="line"><span class="function">  </span></span><br><span class="line"><span class="function">  // <span class="params">markRaw</span>标记<span class="params">pinia</span>不可被代理,避免存在用户将其响应式化影响性能的情况</span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">pinia</span>: <span class="params">Pinia</span> = <span class="params">markRaw</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    install(<span class="params">app: App</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="comment">// 设置当前活跃的pinia，方便其他地方获取</span></span></span></span><br><span class="line"><span class="function"><span class="params">      setActivePinia(<span class="params">pinia</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">if</span> (<span class="params">!isVue2</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">        pinia._a = app</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="comment">// 内部通过inject获取pinia,因为piniaSymbol没有导出，所以开发者无法通过inject获取pinia</span></span></span></span><br><span class="line"><span class="function"><span class="params">        app.provide(<span class="params">piniaSymbol, pinia</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="comment">// 通过app.config.globalProperties将pinia挂载到组件实例上</span></span></span></span><br><span class="line"><span class="function"><span class="params">        app.config.globalProperties.$pinia = pinia</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">if</span> (<span class="params">USE_DEVTOOLS</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">          registerPiniaDevtools(<span class="params">app, pinia</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">        &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">        toBeInstalled.forEach(<span class="params">(<span class="params">plugin</span>) =&gt; _p.push(<span class="params">plugin</span>)</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">        toBeInstalled = []</span></span></span><br><span class="line"><span class="function"><span class="params">      &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">// pinia插件相关，暂不分析</span></span></span></span><br><span class="line"><span class="function"><span class="params">    use(<span class="params">plugin</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">if</span> (<span class="params">!<span class="keyword">this</span>._a &amp;&amp; !isVue2</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">        toBeInstalled.push(<span class="params">plugin</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">      &#125; <span class="keyword">else</span> &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">        _p.push(<span class="params">plugin</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">      &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">return</span> <span class="keyword">this</span></span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;,</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    _p,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">// it's actually undefined here</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">// @ts-expect-error</span></span></span></span><br><span class="line"><span class="function"><span class="params">    _a: <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    _e: scope,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">// 每个创建的store都会放在这个Map里</span></span></span></span><br><span class="line"><span class="function"><span class="params">    _s: <span class="keyword">new</span> Map&lt;<span class="built_in">string</span>, StoreGeneric&gt;(<span class="params"></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">    state,</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  //...</span></span><br><span class="line"><span class="function">  <span class="params">return</span> <span class="params">pinia</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="设置、获取pinia"><a href="#设置、获取pinia" class="headerlink" title="设置、获取pinia"></a>设置、获取pinia</h2><ul>
<li>pinia会被保存到一个全局变量上，内部可以通过setActivePinia、getActivePinia快速获取到pinia，然后使用上一步挂在pinia上的属性或方法</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//rootStore.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> activePinia: Pinia | <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> setActivePinia = <span class="function">(<span class="params">pinia: Pinia | <span class="literal">undefined</span></span>) =&gt;</span></span><br><span class="line">  (activePinia = pinia)</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 如果在vue组件中，通过inject获取（在createPinia中导出）、否则直接取全局变量 </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getActivePinia = <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">  (getCurrentInstance() &amp;&amp; inject(piniaSymbol)) || activePinia</span><br></pre></td></tr></table></figure>

<h2 id="兼容vue2"><a href="#兼容vue2" class="headerlink" title="兼容vue2"></a>兼容vue2</h2><ul>
<li>看过vuex的这段应该很熟悉</li>
<li>通过Object.defineProperty仿造了个Provide功能</li>
<li>通过mixins将pinia注入到每一个组件中</li>
</ul>
<p>PiniaVuePlugin</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//vue2-plugin.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> PiniaVuePlugin: Plugin = <span class="function"><span class="keyword">function</span> (<span class="params">_Vue</span>) </span>&#123;</span><br><span class="line">  _Vue.mixin(&#123;</span><br><span class="line">    beforeCreate() &#123;</span><br><span class="line">      <span class="keyword">const</span> options = <span class="keyword">this</span>.$options</span><br><span class="line">      <span class="keyword">if</span> (options.pinia) &#123;</span><br><span class="line">      <span class="comment">// 获取注册到根组件上的pinia</span></span><br><span class="line">        <span class="keyword">const</span> pinia = options.pinia <span class="keyword">as</span> Pinia</span><br><span class="line">        <span class="comment">// 通过Object.defineProperty实现的hack版provid、inject...</span></span><br><span class="line">        <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">as</span> <span class="built_in">any</span>)._provided) &#123;</span><br><span class="line">          <span class="keyword">const</span> provideCache = &#123;&#125;</span><br><span class="line">          <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>, <span class="string">'_provided'</span>, &#123;</span><br><span class="line">            <span class="keyword">get</span>: <span class="function"><span class="params">()</span> =&gt;</span> provideCache,</span><br><span class="line">            <span class="keyword">set</span>: <span class="function">(<span class="params">v</span>) =&gt;</span> <span class="built_in">Object</span>.assign(provideCache, v),</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        ;(<span class="keyword">this</span> <span class="keyword">as</span> <span class="built_in">any</span>)._provided[piniaSymbol <span class="keyword">as</span> <span class="built_in">any</span>] = pinia</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.$pinia) &#123;</span><br><span class="line">          <span class="keyword">this</span>.$pinia = pinia</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pinia._a = <span class="keyword">this</span> <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">        <span class="keyword">if</span> (IS_CLIENT) &#123;</span><br><span class="line">          <span class="comment">// this allows calling useStore() outside of a component setup after</span></span><br><span class="line">          <span class="comment">// installing pinia's plugin</span></span><br><span class="line">          setActivePinia(pinia)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (USE_DEVTOOLS) &#123;</span><br><span class="line">          registerPiniaDevtools(pinia._a, pinia)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.$pinia &amp;&amp; options.parent &amp;&amp; options.parent.$pinia) &#123;</span><br><span class="line">        <span class="keyword">this</span>.$pinia = options.parent.$pinia</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    destroyed() &#123;</span><br><span class="line">      <span class="keyword">delete</span> <span class="keyword">this</span>._pStores</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建store"><a href="#创建store" class="headerlink" title="创建store"></a>创建store</h2><p>创建store的三种方式</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> useUserStore = defineStore(<span class="string">'counter'</span>, &#123;</span><br><span class="line">  state: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    count: <span class="number">0</span></span><br><span class="line">  &#125;),</span><br><span class="line">  actions: &#123;</span><br><span class="line">    increment() &#123;</span><br><span class="line">      <span class="keyword">this</span>.count++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">const</span> useUserStore = defineStore(&#123;</span><br><span class="line">  id: <span class="string">'counter'</span>,</span><br><span class="line">  state: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    count: <span class="number">0</span></span><br><span class="line">  &#125;),</span><br><span class="line">  actions: &#123;</span><br><span class="line">    increment() &#123;</span><br><span class="line">      <span class="keyword">this</span>.count++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">const</span> useUserStore = defineStore(<span class="string">'counter'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> count = ref(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">increment</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    count.value++</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; count, increment &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="defineStore"><a href="#defineStore" class="headerlink" title="defineStore"></a>defineStore</h2><ul>
<li>主要根据defineStore的不同方式选择调用函数式createSetupStore还是选项式createOptionsStore</li>
<li>创建好的store会根据defineStore时传入的id，挂载到pinia._s这个map上</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">defineStore</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="comment">// <span class="doctag">TODO:</span> add proper types from above</span></span></span></span><br><span class="line"><span class="function"><span class="params">  idOrOptions: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  setup?: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  setupOptions?: <span class="built_in">any</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">StoreDefinition</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> id: <span class="built_in">string</span></span><br><span class="line">  <span class="keyword">let</span> options</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> isSetupStore = <span class="keyword">typeof</span> setup === <span class="string">'function'</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 抹平不同格式参数</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> idOrOptions === <span class="string">'string'</span>) &#123;</span><br><span class="line">    id = idOrOptions</span><br><span class="line">    options = isSetupStore ? setupOptions : setup</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    options = idOrOptions</span><br><span class="line">    id = idOrOptions.id</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 最终交给开发者获取store的方法</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">useStore</span>(<span class="params">pinia?: Pinia | <span class="literal">null</span>, hot?: StoreGeneric</span>): <span class="title">StoreGeneric</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">const</span> currentInstance = getCurrentInstance()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果存在currentInstance说明在vue组件中，通过inject获取到pinia</span></span><br><span class="line">    pinia =</span><br><span class="line">      (__TEST__ &amp;&amp; activePinia &amp;&amp; activePinia._testing ? <span class="literal">null</span> : pinia) ||</span><br><span class="line">      (currentInstance &amp;&amp; inject(piniaSymbol, <span class="literal">null</span>))</span><br><span class="line">    </span><br><span class="line">      <span class="comment">//设置当前活跃的pinia对象，如果存在多个pinia对象，方便快速获取当前pinia对象</span></span><br><span class="line">    <span class="keyword">if</span> (pinia) setActivePinia(pinia)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; !activePinia) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">`[🍍]: getActivePinia was called with no active Pinia. Did you forget to install pinia?\n`</span> +</span><br><span class="line">          <span class="string">`\tconst pinia = createPinia()\n`</span> +</span><br><span class="line">          <span class="string">`\tapp.use(pinia)\n`</span> +</span><br><span class="line">          <span class="string">`This will fail in production.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 从rootStore文件中取的全局变量</span></span><br><span class="line">    pinia = activePinia!</span><br><span class="line">    <span class="comment">// 如果没有创建过id对应的store,则会调用createSetupStore或createOptionsStore进行创建</span></span><br><span class="line">    <span class="keyword">if</span> (!pinia._s.has(id)) &#123;</span><br><span class="line">      <span class="comment">// 区分第二个参数是函数还是options对象</span></span><br><span class="line">      <span class="keyword">if</span> (isSetupStore) &#123;</span><br><span class="line">        createSetupStore(id, setup, options, pinia)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        createOptionsStore(id, options <span class="keyword">as</span> <span class="built_in">any</span>, pinia)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="comment">// @ts-expect-error: not the right inferred type</span></span><br><span class="line">        useStore._pinia = pinia</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取上面创建好的store，pinia._s是一个Map结构</span></span><br><span class="line">    <span class="keyword">const</span> store: StoreGeneric = pinia._s.get(id)!</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 热更新相关,重新创建更新store</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; hot) &#123;</span><br><span class="line">      <span class="keyword">const</span> hotId = <span class="string">'__hot:'</span> + id</span><br><span class="line">      <span class="keyword">const</span> newStore = isSetupStore</span><br><span class="line">        ? createSetupStore(hotId, setup, options, pinia, <span class="literal">true</span>)</span><br><span class="line">        : createOptionsStore(hotId, assign(&#123;&#125;, options) <span class="keyword">as</span> <span class="built_in">any</span>, pinia, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">      hot._hotUpdate(newStore)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// cleanup the state properties and the store from the cache</span></span><br><span class="line">      <span class="keyword">delete</span> pinia.state.value[hotId]</span><br><span class="line">      pinia._s.delete(hotId)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 往当前组件实例上缓存store，主要是给devtools使用</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      __DEV__ &amp;&amp;</span><br><span class="line">      IS_CLIENT &amp;&amp;</span><br><span class="line">      currentInstance &amp;&amp;</span><br><span class="line">      currentInstance.proxy &amp;&amp;</span><br><span class="line">      <span class="comment">// avoid adding stores that are just built for hot module replacement</span></span><br><span class="line">      !hot</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">const</span> vm = currentInstance.proxy</span><br><span class="line">      <span class="keyword">const</span> cache = <span class="string">'_pStores'</span> <span class="keyword">in</span> vm ? vm._pStores! : (vm._pStores = &#123;&#125;)</span><br><span class="line">      cache[id] = store</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// StoreGeneric cannot be casted towards Store</span></span><br><span class="line">    <span class="keyword">return</span> store <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  useStore.$id = id</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> useStore</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="createSetupStore"><a href="#createSetupStore" class="headerlink" title="createSetupStore"></a>createSetupStore</h2><p>如果defineStore传入的是一个setup函数，则会调用此方法创建store</p>
<ul>
<li><h3 id="响应式处理store"><a href="#响应式处理store" class="headerlink" title="响应式处理store"></a>响应式处理store</h3><ul>
<li>store -&gt; reactive(store)</li>
<li>pinia.state.value[storeId]初始化，state会往pinia上存一份和在store上存一份</li>
<li>将store注册到pinia._s这个Map上</li>
</ul>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSetupStore</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  $id: Id,</span></span></span><br><span class="line"><span class="function"><span class="params">  setup: () =&gt; SS,</span></span></span><br><span class="line"><span class="function"><span class="params">  options:</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineSetupStoreOptions&lt;Id, S, G, A&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineStoreOptions&lt;Id, S, G, A&gt; = &#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pinia: Pinia,</span></span></span><br><span class="line"><span class="function"><span class="params">  hot?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  isOptionsStore?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">let</span> scope!: EffectScope  <span class="comment">//为setup函数返回的内容单独建立一个scope</span></span><br><span class="line"><span class="keyword">if</span> (__DEV__ &amp;&amp; !pinia._e.active) &#123; <span class="comment">//pinia._e为创建pinia时建立的scope</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Pinia destroyed'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = pinia.state.value[$id] <span class="keyword">as</span> UnwrapRef&lt;S&gt; | <span class="literal">undefined</span></span><br><span class="line"><span class="comment">// 如果pinia.state.value[storeId]未初始化，进行初始化</span></span><br><span class="line"><span class="keyword">if</span> (!isOptionsStore &amp;&amp; !initialState &amp;&amp; (!__DEV__ || !hot)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (isVue2) &#123;</span><br><span class="line">    <span class="keyword">set</span>(pinia.state.value, $id, &#123;&#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    pinia.state.value[$id] = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对外暴露的store内容</span></span><br><span class="line"><span class="keyword">const</span> partialStore = &#123;</span><br><span class="line"> _p: pinia,</span><br><span class="line"> <span class="comment">// _s: scope,</span></span><br><span class="line"> $id,</span><br><span class="line"> <span class="comment">// 调用$onAction会将回调加入到actionSubscriptions中,wrapAction内会触发回调</span></span><br><span class="line"> $onAction: addSubscription.bind(<span class="literal">null</span>, actionSubscriptions),</span><br><span class="line"> $patch,</span><br><span class="line"> $reset,</span><br><span class="line"> $subscribe(callback, options = &#123;&#125;) &#123;</span><br><span class="line">   <span class="keyword">const</span> removeSubscription = addSubscription(</span><br><span class="line">     subscriptions,</span><br><span class="line">     callback,</span><br><span class="line">     options.detached,</span><br><span class="line">     () =&gt; stopWatcher()</span><br><span class="line">   )</span><br><span class="line">   <span class="comment">// 监听state直接修改</span></span><br><span class="line">   <span class="keyword">const</span> stopWatcher = scope.run(<span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">     watch(</span><br><span class="line">       () =&gt; pinia.state.value[$id] <span class="keyword">as</span> UnwrapRef&lt;S&gt;,</span><br><span class="line">       (state) =&gt; &#123;</span><br><span class="line">         <span class="comment">// flush默认为'pre',而在调用$patch时isListening会被设置为false,所以不会触发$patch修改state的监听回调</span></span><br><span class="line">         <span class="keyword">if</span> (options.flush === <span class="string">'sync'</span> ? isSyncListening : isListening) &#123;</span><br><span class="line">           callback(</span><br><span class="line">             &#123;</span><br><span class="line">               storeId: $id,</span><br><span class="line">               <span class="keyword">type</span>: MutationType.direct,</span><br><span class="line">               events: debuggerEvents <span class="keyword">as</span> DebuggerEvent,</span><br><span class="line">             &#125;,</span><br><span class="line">             state</span><br><span class="line">           )</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;,</span><br><span class="line">       assign(&#123;&#125;, $subscribeOptions, options)</span><br><span class="line">     )</span><br><span class="line">   )!</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> removeSubscription</span><br><span class="line"> &#125;,</span><br><span class="line"> $dispose,</span><br><span class="line">&#125; <span class="keyword">as</span> _StoreWithState&lt;Id, S, G, A&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回的store是个reactive对象</span></span><br><span class="line"><span class="keyword">const</span> store: Store&lt;Id, S, G, A&gt; = reactive(</span><br><span class="line">  __DEV__ || USE_DEVTOOLS</span><br><span class="line">    ? assign(</span><br><span class="line">        &#123;</span><br><span class="line">          _hmrPayload,</span><br><span class="line">          _customProperties: markRaw(<span class="keyword">new</span> Set&lt;<span class="built_in">string</span>&gt;()), <span class="comment">// devtools custom properties</span></span><br><span class="line">        &#125;,</span><br><span class="line">        partialStore</span><br><span class="line">        <span class="comment">// must be added later</span></span><br><span class="line">        <span class="comment">// setupStore</span></span><br><span class="line">      )</span><br><span class="line">    : partialStore</span><br><span class="line">) <span class="keyword">as</span> unknown <span class="keyword">as</span> Store&lt;Id, S, G, A&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将store注册到pinia上</span></span><br><span class="line">pinia._s.set($id, store)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h3 id="处理setup返回的内容"><a href="#处理setup返回的内容" class="headerlink" title="处理setup返回的内容"></a>处理setup返回的内容</h3></li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">createSetupStore</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  $id: Id,</span></span></span><br><span class="line"><span class="function"><span class="params">  setup: () =&gt; SS,</span></span></span><br><span class="line"><span class="function"><span class="params">  options:</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineSetupStoreOptions&lt;Id, S, G, A&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineStoreOptions&lt;Id, S, G, A&gt; = &#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pinia: Pinia,</span></span></span><br><span class="line"><span class="function"><span class="params">  hot?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  isOptionsStore?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>)</span>&#123;</span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">// 将defineStore使用者定义的返回内容放进scope中,在组件卸载时回收effect</span></span><br><span class="line"> <span class="keyword">const</span> setupStore = pinia._e.run(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">   scope = effectScope()</span><br><span class="line">   <span class="keyword">return</span> scope.run(<span class="function"><span class="params">()</span> =&gt;</span> setup())</span><br><span class="line"> &#125;)!</span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h3 id="同步setup返回内容和pinia-state"><a href="#同步setup返回内容和pinia-state" class="headerlink" title="同步setup返回内容和pinia.state"></a>同步setup返回内容和pinia.state</h3><ul>
<li>因为state会在store上存一份，也会在pinia.state.value[storeId]上存一份，所以为了保证两边都是同一个代理对象，需要进行同步</li>
<li>使用者可以直接通过pinia.state.value设置store内容，所以直接设置的内容也需要同步</li>
</ul>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">createSetupStore</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  $id: Id,</span></span></span><br><span class="line"><span class="function"><span class="params">  setup: () =&gt; SS,</span></span></span><br><span class="line"><span class="function"><span class="params">  options:</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineSetupStoreOptions&lt;Id, S, G, A&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineStoreOptions&lt;Id, S, G, A&gt; = &#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pinia: Pinia,</span></span></span><br><span class="line"><span class="function"><span class="params">  hot?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  isOptionsStore?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>)</span>&#123;</span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 将defineStore使用者定义的返回内容放进scope中,在组件卸载时回收effect</span></span><br><span class="line"><span class="keyword">const</span> setupStore = pinia._e.run(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  scope = effectScope()</span><br><span class="line">  <span class="keyword">return</span> scope.run(<span class="function"><span class="params">()</span> =&gt;</span> setup())</span><br><span class="line">&#125;)!</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> setupStore) &#123;</span><br><span class="line"> <span class="keyword">const</span> prop = setupStore[key]</span><br><span class="line"> <span class="comment">// 只处理ref、reactive对象，computed等不处理</span></span><br><span class="line"> <span class="keyword">if</span> ((isRef(prop) &amp;&amp; !isComputed(prop)) || isReactive(prop)) &#123;</span><br><span class="line">   <span class="comment">// mark it as a piece of state to be serialized</span></span><br><span class="line">   <span class="keyword">if</span> (__DEV__ &amp;&amp; hot) &#123;</span><br><span class="line">     <span class="comment">// 热更新相关，忽略</span></span><br><span class="line">     <span class="keyword">set</span>(hotState.value, key, toRef(setupStore <span class="keyword">as</span> <span class="built_in">any</span>, key))</span><br><span class="line">     <span class="comment">// option结构已经在createOptionsStore将其加入pinia</span></span><br><span class="line">     </span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isOptionsStore) &#123;<span class="comment">// 同步pinia.state -&gt; store</span></span><br><span class="line">   </span><br><span class="line">     <span class="comment">// 将用户可能直接调用pinia.state.value[$id]设置的ref、reactive对象设置到setup返回的结果上,让二者的响应式都代理一个对象</span></span><br><span class="line">     <span class="comment">// 使得store、pinia能同步更改</span></span><br><span class="line">     <span class="keyword">if</span> (initialState &amp;&amp; shouldHydrate(prop)) &#123;</span><br><span class="line">       <span class="keyword">if</span> (isRef(prop)) &#123;</span><br><span class="line">         prop.value = initialState[key]</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// probably a reactive object, lets recursively assign</span></span><br><span class="line">         <span class="comment">// 同步其他类型</span></span><br><span class="line">         mergeReactiveObjects(prop, initialState[key])</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// transfer the ref to the pinia state to keep everything in sync</span></span><br><span class="line">     <span class="comment">// 将setup返回的ref、reactive对象同步到pinia.state上，使得store、pinia能同步更改</span></span><br><span class="line">     <span class="keyword">if</span> (isVue2) &#123; <span class="comment">//同步 store -&gt; pinia.state</span></span><br><span class="line">       <span class="keyword">set</span>(pinia.state.value[$id], key, prop)</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       pinia.state.value[$id][key] = prop</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 合并方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeReactiveObjects</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">T</span> <span class="title">extends</span> <span class="title">Record</span>&lt;<span class="title">any</span>, <span class="title">unknown</span>&gt; | <span class="title">Map</span>&lt;<span class="title">unknown</span>, <span class="title">unknown</span>&gt; | <span class="title">Set</span>&lt;<span class="title">unknown</span>&gt;</span></span><br><span class="line"><span class="function">&gt;(<span class="params">target: T, patchToApply: _DeepPartial&lt;T&gt;</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 合并Map类型</span></span><br><span class="line">  <span class="keyword">if</span> (target <span class="keyword">instanceof</span> Map &amp;&amp; patchToApply <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">    patchToApply.forEach(<span class="function">(<span class="params">value, key</span>) =&gt;</span> target.set(key, value))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 合并Set类型</span></span><br><span class="line">  <span class="keyword">if</span> (target <span class="keyword">instanceof</span> Set &amp;&amp; patchToApply <span class="keyword">instanceof</span> Set) &#123;</span><br><span class="line">    patchToApply.forEach(target.add, target)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> patchToApply) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!patchToApply.hasOwnProperty(key)) <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">const</span> subPatch = patchToApply[key]</span><br><span class="line">    <span class="keyword">const</span> targetValue = target[key]</span><br><span class="line">    <span class="comment">// 只有普通对象才会进入递归</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      isPlainObject(targetValue) &amp;&amp;</span><br><span class="line">      isPlainObject(subPatch) &amp;&amp;</span><br><span class="line">      target.hasOwnProperty(key) &amp;&amp;</span><br><span class="line">      !isRef(subPatch) &amp;&amp;</span><br><span class="line">      !isReactive(subPatch)</span><br><span class="line">    ) &#123;</span><br><span class="line">      target[key] = mergeReactiveObjects(targetValue, subPatch)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      target[key] = subPatch</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> target</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h3 id="处理action"><a href="#处理action" class="headerlink" title="处理action"></a>处理action</h3><ul>
<li>将action替换成wrapAction，wrapAction添加了订阅发布相关的功能</li>
</ul>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">createSetupStore</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  $id: Id,</span></span></span><br><span class="line"><span class="function"><span class="params">  setup: () =&gt; SS,</span></span></span><br><span class="line"><span class="function"><span class="params">  options:</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineSetupStoreOptions&lt;Id, S, G, A&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineStoreOptions&lt;Id, S, G, A&gt; = &#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pinia: Pinia,</span></span></span><br><span class="line"><span class="function"><span class="params">  hot?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  isOptionsStore?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>)</span>&#123;</span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 将defineStore使用者定义的返回内容放进scope中,在组件卸载时回收effect</span></span><br><span class="line"><span class="keyword">const</span> setupStore = pinia._e.run(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  scope = effectScope()</span><br><span class="line">  <span class="keyword">return</span> scope.run(<span class="function"><span class="params">()</span> =&gt;</span> setup())</span><br><span class="line">&#125;)!</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> setupStore) &#123;</span><br><span class="line"> <span class="keyword">const</span> prop = setupStore[key]</span><br><span class="line"> <span class="comment">// 只处理ref、reactive对象，computed等不处理</span></span><br><span class="line"> <span class="keyword">if</span> ((isRef(prop) &amp;&amp; !isComputed(prop)) || isReactive(prop)) &#123;</span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line"> &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> prop === <span class="string">'function'</span>) &#123; </span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 将setup中的方法替换成wrapAction包装的方法，wrapAction在订阅发布章节解析</span></span><br><span class="line">  </span><br><span class="line">      <span class="keyword">const</span> actionValue = __DEV__ &amp;&amp; hot ? prop : wrapAction(key, prop)</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (isVue2) &#123;</span><br><span class="line">        <span class="keyword">set</span>(setupStore, key, actionValue)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// @ts-expect-error</span></span><br><span class="line">        setupStore[key] = actionValue</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        _hmrPayload.actions[key] = prop</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// list actions so they can be used in plugins</span></span><br><span class="line">      <span class="comment">// @ts-expect-error</span></span><br><span class="line">      optionsForPlugin.actions[key] = prop</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h3 id="处理store合并setup"><a href="#处理store合并setup" class="headerlink" title="处理store合并setup"></a>处理store合并setup</h3></li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">createSetupStore</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  $id: Id,</span></span></span><br><span class="line"><span class="function"><span class="params">  setup: () =&gt; SS,</span></span></span><br><span class="line"><span class="function"><span class="params">  options:</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineSetupStoreOptions&lt;Id, S, G, A&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineStoreOptions&lt;Id, S, G, A&gt; = &#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pinia: Pinia,</span></span></span><br><span class="line"><span class="function"><span class="params">  hot?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  isOptionsStore?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// 对外暴露的store API</span></span><br><span class="line"><span class="keyword">const</span> partialStore = &#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> store: Store&lt;Id, S, G, A&gt; = reactive(</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">partialStore</span><br><span class="line">)</span><br><span class="line"><span class="comment">// 将defineStore使用者定义的返回内容放进scope中,在组件卸载时回收effect</span></span><br><span class="line"><span class="keyword">const</span> setupStore = pinia._e.run(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">scope = effectScope()</span><br><span class="line"><span class="keyword">return</span> scope.run(<span class="function"><span class="params">()</span> =&gt;</span> setup())</span><br><span class="line">&#125;)!</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> setupStore) &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 将最同步后的结果，合并进store上</span></span><br><span class="line"> <span class="keyword">if</span> (isVue2) &#123;</span><br><span class="line">   <span class="built_in">Object</span>.keys(setupStore).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">set</span>(store, key, setupStore[key])</span><br><span class="line">   &#125;)</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="comment">// 将store的reactive对象、原始对象都进行合并</span></span><br><span class="line">   assign(store, setupStore)</span><br><span class="line">   assign(toRaw(store), setupStore)</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="createOptionsStore"><a href="#createOptionsStore" class="headerlink" title="createOptionsStore"></a>createOptionsStore</h2><p>当传入的是option配置时，则会调用此方法创建store</p>
<ul>
<li>createSetupStore内部会将option转换成setup方法，然后实际调用createSetupStore进行创建</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createOptionsStore</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">Id</span> <span class="title">extends</span> <span class="title">string</span>,</span></span><br><span class="line"><span class="function">  <span class="title">S</span> <span class="title">extends</span> <span class="title">StateTree</span>,</span></span><br><span class="line"><span class="function">  <span class="title">G</span> <span class="title">extends</span> <span class="title">_GettersTree</span>&lt;<span class="title">S</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">A</span> <span class="title">extends</span> <span class="title">_ActionsTree</span></span></span><br><span class="line"><span class="function">&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  id: Id,</span></span></span><br><span class="line"><span class="function"><span class="params">  options: DefineStoreOptions&lt;Id, S, G, A&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pinia: Pinia,</span></span></span><br><span class="line"><span class="function"><span class="params">  hot?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Store</span>&lt;<span class="title">Id</span>, <span class="title">S</span>, <span class="title">G</span>, <span class="title">A</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; state, actions, getters &#125; = options</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> initialState: StateTree | <span class="literal">undefined</span> = pinia.state.value[id]</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">let</span> store: Store&lt;Id, S, G, A&gt;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 将options转化成setup函数</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 初始化pinia.state</span></span><br><span class="line">    <span class="keyword">if</span> (!initialState &amp;&amp; (!__DEV__ || !hot)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isVue2) &#123;</span><br><span class="line">        <span class="keyword">set</span>(pinia.state.value, id, state ? state() : &#123;&#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pinia.state.value[id] = state ? state() : &#123;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将pinia.state全部转换成ref，和setup中返回ref效果一致</span></span><br><span class="line">    <span class="keyword">const</span> localState =</span><br><span class="line">      __DEV__ &amp;&amp; hot</span><br><span class="line">        ? <span class="comment">// use ref() to unwrap refs inside state <span class="doctag">TODO:</span> check if this is still necessary</span></span><br><span class="line">          toRefs(ref(state ? state() : &#123;&#125;).value)</span><br><span class="line">        : toRefs(pinia.state.value[id])</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 最终options store返回的内容格式和setup store返回的内容格式一致</span></span><br><span class="line">    <span class="keyword">return</span> assign(</span><br><span class="line">      localState,</span><br><span class="line">      actions,</span><br><span class="line">      <span class="comment">// 将 getter 转换成 computed</span></span><br><span class="line">      <span class="built_in">Object</span>.keys(getters || &#123;&#125;).reduce(<span class="function">(<span class="params">computedGetters, name</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__ &amp;&amp; name <span class="keyword">in</span> localState) &#123;</span><br><span class="line">          <span class="built_in">console</span>.warn(</span><br><span class="line">            <span class="string">`[🍍]: A getter cannot have the same name as another state property. Rename one of them. Found with "<span class="subst">$&#123;name&#125;</span>" in store "<span class="subst">$&#123;id&#125;</span>".`</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// getter函数不可代理，及不对computed做额外处理，和setup中一致</span></span><br><span class="line">        computedGetters[name] = markRaw(</span><br><span class="line">          computed(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            setActivePinia(pinia)</span><br><span class="line">            <span class="comment">// it was created just before</span></span><br><span class="line">            <span class="keyword">const</span> store = pinia._s.get(id)!</span><br><span class="line"></span><br><span class="line">            <span class="comment">// allow cross using stores</span></span><br><span class="line">            <span class="keyword">if</span> (isVue2 &amp;&amp; !store._r) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// @ts-expect-error</span></span><br><span class="line">            <span class="comment">// return getters![name].call(context, context)</span></span><br><span class="line">            <span class="keyword">return</span> getters![name].call(store, store)</span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> computedGetters</span><br><span class="line">      &#125;, &#123;&#125; <span class="keyword">as</span> Record&lt;<span class="built_in">string</span>, ComputedRef&gt;)</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// option选项注册的pinia会被转换成setup函数形式</span></span><br><span class="line">  store = createSetupStore(id, setup, options, pinia, hot, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">  store.$reset = <span class="function"><span class="keyword">function</span> <span class="title">$reset</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> newState = state ? state() : &#123;&#125;</span><br><span class="line">    <span class="comment">// we use a patch to group all changes into one single subscription</span></span><br><span class="line">    <span class="keyword">this</span>.$patch(<span class="function">(<span class="params">$state</span>) =&gt;</span> &#123;</span><br><span class="line">      assign($state, newState)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> store <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="订阅发布"><a href="#订阅发布" class="headerlink" title="订阅发布"></a>订阅发布</h2><p>pinia能够对修改state、action进行监听，内部通过发布订阅模式、watch API实现</p>
<ul>
<li><h2 id="发布订阅模式"><a href="#发布订阅模式" class="headerlink" title="发布订阅模式"></a>发布订阅模式</h2><ul>
<li>将存储订阅器的功能和整个设计解藕，交给外部来传入，好处是能够处理不同类型的发布订阅</li>
</ul>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//subscriptions.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">addSubscription</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">_Method</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  subscriptions: T[], <span class="comment">//外部传入存储器</span></span></span></span><br><span class="line"><span class="function"><span class="params">  callback: T,</span></span></span><br><span class="line"><span class="function"><span class="params">  detached?: <span class="built_in">boolean</span>, <span class="comment">// 是否在组件卸载时清除订阅</span></span></span></span><br><span class="line"><span class="function"><span class="params">  onCleanup: () =&gt; <span class="built_in">void</span> = noop</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  subscriptions.push(callback)</span><br><span class="line">  <span class="comment">// 清除订阅</span></span><br><span class="line">  <span class="keyword">const</span> removeSubscription = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> idx = subscriptions.indexOf(callback)</span><br><span class="line">    <span class="keyword">if</span> (idx &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      subscriptions.splice(idx, <span class="number">1</span>)</span><br><span class="line">      onCleanup()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果没传detached,则会自动在组件卸载时清除订阅</span></span><br><span class="line">  <span class="keyword">if</span> (!detached &amp;&amp; getCurrentScope()) &#123;</span><br><span class="line">    onScopeDispose(removeSubscription)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> removeSubscription</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">triggerSubscriptions</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">_Method</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  subscriptions: T[],</span></span></span><br><span class="line"><span class="function"><span class="params">  ...args: Parameters&lt;T&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  subscriptions.slice().forEach(<span class="function">(<span class="params">callback</span>) =&gt;</span> &#123;</span><br><span class="line">    callback(...args)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h2 id="监听action"><a href="#监听action" class="headerlink" title="监听action"></a>监听action</h2></li>
</ul>
<p>基本使用</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> unsubscribe = someStore.$onAction(</span><br><span class="line">  (&#123;</span><br><span class="line">    name, <span class="comment">// action 名称</span></span><br><span class="line">    store, <span class="comment">// store 实例，类似 `someStore`</span></span><br><span class="line">    args, <span class="comment">// 传递给 action 的参数数组</span></span><br><span class="line">    after, <span class="comment">// 在 action 返回或解决后的钩子</span></span><br><span class="line">    onError, <span class="comment">// action 抛出或拒绝的钩子</span></span><br><span class="line">  &#125;) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 这将在执行 "store "的 action 之前触发。</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`xx`</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这将在 action 成功并完全运行后触发。它等待着任何返回的 promise</span></span><br><span class="line">    after(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(</span><br><span class="line">        <span class="string">`Finished "<span class="subst">$&#123;name&#125;</span>" after <span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">          <span class="built_in">Date</span>.now() - startTime</span></span></span><br><span class="line"><span class="string"><span class="subst">        &#125;</span>ms.\nResult: <span class="subst">$&#123;result&#125;</span>.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 action 抛出或返回一个拒绝的 promise，这将触发</span></span><br><span class="line">    onError(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.warn(</span><br><span class="line">        <span class="string">`Failed "<span class="subst">$&#123;name&#125;</span>" after <span class="subst">$&#123;<span class="built_in">Date</span>.now() - startTime&#125;</span>ms.\nError: <span class="subst">$&#123;error&#125;</span>.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 手动删除监听器</span></span><br><span class="line">unsubscribe()</span><br></pre></td></tr></table></figure>

<h3 id="通过-onAction添加订阅"><a href="#通过-onAction添加订阅" class="headerlink" title="通过$onAction添加订阅"></a>通过$onAction添加订阅</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSetupStore</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">Id</span> <span class="title">extends</span> <span class="title">string</span>,</span></span><br><span class="line"><span class="function">  <span class="title">SS</span> <span class="title">extends</span> <span class="title">Record</span>&lt;<span class="title">any</span>, <span class="title">unknown</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">S</span> <span class="title">extends</span> <span class="title">StateTree</span>,</span></span><br><span class="line"><span class="function">  <span class="title">G</span> <span class="title">extends</span> <span class="title">Record</span>&lt;<span class="title">string</span>, <span class="title">_Method</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">A</span> <span class="title">extends</span> <span class="title">_ActionsTree</span></span></span><br><span class="line"><span class="function">&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  $id: Id,</span></span></span><br><span class="line"><span class="function"><span class="params">  setup: () =&gt; SS,</span></span></span><br><span class="line"><span class="function"><span class="params">  options:</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineSetupStoreOptions&lt;Id, S, G, A&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineStoreOptions&lt;Id, S, G, A&gt; = &#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pinia: Pinia,</span></span></span><br><span class="line"><span class="function"><span class="params">  hot?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  isOptionsStore?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Store</span>&lt;<span class="title">Id</span>, <span class="title">S</span>, <span class="title">G</span>, <span class="title">A</span>&gt; </span>&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// 对外暴露的store内容</span></span><br><span class="line"><span class="keyword">const</span> partialStore = &#123;</span><br><span class="line"> _p: pinia,</span><br><span class="line"> <span class="comment">// _s: scope,</span></span><br><span class="line"> $id,</span><br><span class="line"> <span class="comment">// 调用$onAction会将回调加入到actionSubscriptions中,调用wrapAction内会触发回调</span></span><br><span class="line"> $onAction: addSubscription.bind(<span class="literal">null</span>, actionSubscriptions),</span><br><span class="line"> $patch,</span><br><span class="line"> $reset,</span><br><span class="line"> $subscribe(callback, options = &#123;&#125;) &#123;</span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line"> &#125;,</span><br><span class="line"> $dispose,</span><br><span class="line">&#125; <span class="keyword">as</span> _StoreWithState&lt;Id, S, G, A&gt;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="通过wrapAction进行发布"><a href="#通过wrapAction进行发布" class="headerlink" title="通过wrapAction进行发布"></a>通过wrapAction进行发布</h3><ul>
<li>setup、option中的方法，会被替换成wrapAction</li>
<li>当调用wrapAction时，会触发actionSubscriptions、afterCallbackList或onErrorCallbackList中的回调</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSetupStore</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">Id</span> <span class="title">extends</span> <span class="title">string</span>,</span></span><br><span class="line"><span class="function">  <span class="title">SS</span> <span class="title">extends</span> <span class="title">Record</span>&lt;<span class="title">any</span>, <span class="title">unknown</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">S</span> <span class="title">extends</span> <span class="title">StateTree</span>,</span></span><br><span class="line"><span class="function">  <span class="title">G</span> <span class="title">extends</span> <span class="title">Record</span>&lt;<span class="title">string</span>, <span class="title">_Method</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">A</span> <span class="title">extends</span> <span class="title">_ActionsTree</span></span></span><br><span class="line"><span class="function">&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  $id: Id,</span></span></span><br><span class="line"><span class="function"><span class="params">  setup: () =&gt; SS,</span></span></span><br><span class="line"><span class="function"><span class="params">  options:</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineSetupStoreOptions&lt;Id, S, G, A&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineStoreOptions&lt;Id, S, G, A&gt; = &#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pinia: Pinia,</span></span></span><br><span class="line"><span class="function"><span class="params">  hot?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  isOptionsStore?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Store</span>&lt;<span class="title">Id</span>, <span class="title">S</span>, <span class="title">G</span>, <span class="title">A</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// internal state</span></span><br><span class="line"><span class="keyword">let</span> isListening: <span class="built_in">boolean</span> <span class="comment">// 异步监听</span></span><br><span class="line"><span class="keyword">let</span> isSyncListening: <span class="built_in">boolean</span> <span class="comment">// 同步监听</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> subscriptions: SubscriptionCallback&lt;S&gt;[] = markRaw([])  <span class="comment">// 监听state的订阅集合</span></span><br><span class="line"><span class="keyword">let</span> actionSubscriptions: StoreOnActionListener&lt;Id, S, G, A&gt;[] = markRaw([]) <span class="comment">// 监听action的订阅集合</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 包装action调用，追加发布订阅功能</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wrapAction</span>(<span class="params">name: <span class="built_in">string</span>, action: _Method</span>) </span>&#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"><span class="keyword">this</span>: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">   <span class="comment">// 根据闭包上下文，调用时设置当前活跃的pinia</span></span><br><span class="line">   setActivePinia(pinia)</span><br><span class="line">   <span class="keyword">const</span> args = <span class="built_in">Array</span>.from(<span class="built_in">arguments</span>)</span><br><span class="line">   <span class="comment">// 调用action后回调集合</span></span><br><span class="line">   <span class="keyword">const</span> afterCallbackList: <span class="built_in">Array</span>&lt;<span class="function">(<span class="params">resolvedReturn: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">any</span>&gt; = []</span><br><span class="line">   <span class="keyword">const</span> onErrorCallbackList: <span class="built_in">Array</span>&lt;<span class="function">(<span class="params">error: unknown</span>) =&gt;</span> unknown&gt; = []</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">after</span>(<span class="params">callback: _ArrayType&lt;<span class="keyword">typeof</span> afterCallbackList&gt;</span>) </span>&#123;</span><br><span class="line">     afterCallbackList.push(callback)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">onError</span>(<span class="params">callback: _ArrayType&lt;<span class="keyword">typeof</span> onErrorCallbackList&gt;</span>) </span>&#123;</span><br><span class="line">     onErrorCallbackList.push(callback)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 触发action时的回调，同时将after等方法通过参数传入</span></span><br><span class="line">   triggerSubscriptions(actionSubscriptions, &#123;</span><br><span class="line">     args,</span><br><span class="line">     name,</span><br><span class="line">     store,</span><br><span class="line">     after,</span><br><span class="line">     onError,</span><br><span class="line">   &#125;)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">let</span> ret: <span class="built_in">any</span></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     ret = action.apply(<span class="keyword">this</span> &amp;&amp; <span class="keyword">this</span>.$id === $id ? <span class="keyword">this</span> : store, args)</span><br><span class="line">   &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">     <span class="comment">// 处理同步错误</span></span><br><span class="line">     triggerSubscriptions(onErrorCallbackList, error)</span><br><span class="line">     <span class="keyword">throw</span> error</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 如果是异步方法</span></span><br><span class="line">   <span class="keyword">if</span> (ret <span class="keyword">instanceof</span> <span class="built_in">Promise</span>) &#123;</span><br><span class="line">     <span class="keyword">return</span> ret</span><br><span class="line">       .then(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">         <span class="comment">// 获取到action调用结果后触发</span></span><br><span class="line">         triggerSubscriptions(afterCallbackList, value)</span><br><span class="line">         <span class="keyword">return</span> value</span><br><span class="line">       &#125;)</span><br><span class="line">       .catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">         triggerSubscriptions(onErrorCallbackList, error)</span><br><span class="line">         <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error)</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// allow the afterCallback to override the return value</span></span><br><span class="line">   triggerSubscriptions(afterCallbackList, ret)</span><br><span class="line">   <span class="keyword">return</span> ret</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="监听修改state"><a href="#监听修改state" class="headerlink" title="监听修改state"></a>监听修改state</h2><p>修改state有两种方式，一种通过store.state直接修改然后通过watch API进行监听，另一种通过$patch进行<a href="https://so.csdn.net/so/search?q=%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9&spm=1001.2101.3001.7020" target="_blank" rel="noopener">批量修改</a>，通过$patch进行批量修改时，为了只触发一次回调需要手动触发</p>
<ul>
<li>基本使用</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cartStore.$subscribe(<span class="function">(<span class="params">mutation, state</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// import &#123; MutationType &#125; from 'pinia'</span></span><br><span class="line">  mutation.type <span class="comment">// 'direct' | 'patch object' | 'patch function'</span></span><br><span class="line">  <span class="comment">// 和 cartStore.$id 一样</span></span><br><span class="line">  mutation.storeId <span class="comment">// 'cart'</span></span><br><span class="line">  <span class="comment">// 只有 mutation.type === 'patch object'的情况下才可用</span></span><br><span class="line">  mutation.payload <span class="comment">// 传递给 cartStore.$patch() 的补丁对象。</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li><h3 id="直接修改state"><a href="#直接修改state" class="headerlink" title="直接修改state"></a>直接修改state</h3></li>
</ul>
<p>$subscribe监听state直接修改，内部通过watch API实现</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSetupStore</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">Id</span> <span class="title">extends</span> <span class="title">string</span>,</span></span><br><span class="line"><span class="function">  <span class="title">SS</span> <span class="title">extends</span> <span class="title">Record</span>&lt;<span class="title">any</span>, <span class="title">unknown</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">S</span> <span class="title">extends</span> <span class="title">StateTree</span>,</span></span><br><span class="line"><span class="function">  <span class="title">G</span> <span class="title">extends</span> <span class="title">Record</span>&lt;<span class="title">string</span>, <span class="title">_Method</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">A</span> <span class="title">extends</span> <span class="title">_ActionsTree</span></span></span><br><span class="line"><span class="function">&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  $id: Id,</span></span></span><br><span class="line"><span class="function"><span class="params">  setup: () =&gt; SS,</span></span></span><br><span class="line"><span class="function"><span class="params">  options:</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineSetupStoreOptions&lt;Id, S, G, A&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineStoreOptions&lt;Id, S, G, A&gt; = &#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pinia: Pinia,</span></span></span><br><span class="line"><span class="function"><span class="params">  hot?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  isOptionsStore?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Store</span>&lt;<span class="title">Id</span>, <span class="title">S</span>, <span class="title">G</span>, <span class="title">A</span>&gt; </span>&#123;</span><br><span class="line"><span class="comment">// internal state</span></span><br><span class="line"><span class="keyword">let</span> isListening: <span class="built_in">boolean</span> <span class="comment">// set to true at the end</span></span><br><span class="line"><span class="keyword">let</span> isSyncListening: <span class="built_in">boolean</span> <span class="comment">// set to true at the end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// 对外暴露的store内容</span></span><br><span class="line"><span class="keyword">const</span> partialStore = &#123;</span><br><span class="line"> _p: pinia,</span><br><span class="line"> <span class="comment">// _s: scope,</span></span><br><span class="line"> $id,</span><br><span class="line"> <span class="comment">// 调用$onAction会将回调加入到actionSubscriptions中,调用wrapAction内会触发回调</span></span><br><span class="line"> $onAction: addSubscription.bind(<span class="literal">null</span>, actionSubscriptions),</span><br><span class="line"> $patch,</span><br><span class="line"> $reset,</span><br><span class="line"> $subscribe(callback, options = &#123;&#125;) &#123;</span><br><span class="line">    <span class="comment">// 使用者调用后将订阅回调添加进subscriptions</span></span><br><span class="line"><span class="keyword">const</span> removeSubscription = addSubscription(</span><br><span class="line">  subscriptions,</span><br><span class="line">  callback,</span><br><span class="line">  options.detached,</span><br><span class="line">  () =&gt; stopWatcher()</span><br><span class="line">)</span><br><span class="line">      <span class="comment">// 通过watch监听store.state直接修改</span></span><br><span class="line"><span class="keyword">const</span> stopWatcher = scope.run(<span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line"> watch(</span><br><span class="line">   () =&gt; pinia.state.value[$id] <span class="keyword">as</span> UnwrapRef&lt;S&gt;,</span><br><span class="line">   (state) =&gt; &#123;</span><br><span class="line">     <span class="comment">// flush默认为'pre',而在调用$patch时isListening会被设置为false,所以不会触发$patch修改state的监听回调</span></span><br><span class="line">     <span class="comment">// 但对于store.state直接修改的情况，store在创建完成后isSyncListening和isListening都会变成true，所以能够监听</span></span><br><span class="line">     <span class="keyword">if</span> (options.flush === <span class="string">'sync'</span> ? isSyncListening : isListening) &#123;</span><br><span class="line">       callback(</span><br><span class="line">         &#123;</span><br><span class="line">           storeId: $id,</span><br><span class="line">           <span class="keyword">type</span>: MutationType.direct, <span class="comment">// type为direct直接修改</span></span><br><span class="line">           events: debuggerEvents <span class="keyword">as</span> DebuggerEvent,</span><br><span class="line">         &#125;,</span><br><span class="line">         state</span><br><span class="line">       )</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;,</span><br><span class="line">   assign(&#123;&#125;, $subscribeOptions, options)</span><br><span class="line"> )</span><br><span class="line">)!</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> removeSubscription</span><br><span class="line"> &#125;,</span><br><span class="line"> $dispose,</span><br><span class="line">&#125; <span class="keyword">as</span> _StoreWithState&lt;Id, S, G, A&gt;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 整个store创建结束后将两个监听标识为true,意味着store创建完成,可以进行监听订阅操作</span></span><br><span class="line">isListening = <span class="literal">true</span></span><br><span class="line">isSyncListening = <span class="literal">true</span></span><br><span class="line"><span class="keyword">return</span> store</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h3 id="patch修改"><a href="#patch修改" class="headerlink" title="$patch修改"></a>$patch修改</h3></li>
</ul>
<p>$patch用于批量修改state，内部主要通过两个标识位的修改，不触发<a href="https://so.csdn.net/so/search?q=watch%E7%9B%91%E5%90%AC&spm=1001.2101.3001.7020" target="_blank" rel="noopener">watch监听</a>回调</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSetupStore</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">Id</span> <span class="title">extends</span> <span class="title">string</span>,</span></span><br><span class="line"><span class="function">  <span class="title">SS</span> <span class="title">extends</span> <span class="title">Record</span>&lt;<span class="title">any</span>, <span class="title">unknown</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">S</span> <span class="title">extends</span> <span class="title">StateTree</span>,</span></span><br><span class="line"><span class="function">  <span class="title">G</span> <span class="title">extends</span> <span class="title">Record</span>&lt;<span class="title">string</span>, <span class="title">_Method</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">A</span> <span class="title">extends</span> <span class="title">_ActionsTree</span></span></span><br><span class="line"><span class="function">&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  $id: Id,</span></span></span><br><span class="line"><span class="function"><span class="params">  setup: () =&gt; SS,</span></span></span><br><span class="line"><span class="function"><span class="params">  options:</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineSetupStoreOptions&lt;Id, S, G, A&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">    | DefineStoreOptions&lt;Id, S, G, A&gt; = &#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">  pinia: Pinia,</span></span></span><br><span class="line"><span class="function"><span class="params">  hot?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  isOptionsStore?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Store</span>&lt;<span class="title">Id</span>, <span class="title">S</span>, <span class="title">G</span>, <span class="title">A</span>&gt; </span>&#123;</span><br><span class="line"><span class="comment">// internal state</span></span><br><span class="line"><span class="keyword">let</span> isListening: <span class="built_in">boolean</span> <span class="comment">// set to true at the end</span></span><br><span class="line"><span class="keyword">let</span> isSyncListening: <span class="built_in">boolean</span> <span class="comment">// set to true at the end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">$patch</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params"> partialStateOrMutator:</span></span></span><br><span class="line"><span class="function"><span class="params">   | _DeepPartial&lt;UnwrapRef&lt;S&gt;&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">   | ((state: UnwrapRef&lt;S&gt;) =&gt; <span class="built_in">void</span>)</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line"> <span class="comment">// 订阅$patch操作type</span></span><br><span class="line"> <span class="keyword">let</span> subscriptionMutation: SubscriptionCallbackMutation&lt;S&gt;</span><br><span class="line"> <span class="comment">// 避免批量修改触发$subscribe</span></span><br><span class="line"> isListening = isSyncListening = <span class="literal">false</span></span><br><span class="line"> </span><br><span class="line"> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">   debuggerEvents = []</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// 兼容$patch传递函数、对象调用的两种调用方式</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">typeof</span> partialStateOrMutator === <span class="string">'function'</span>) &#123;</span><br><span class="line">   partialStateOrMutator(pinia.state.value[$id] <span class="keyword">as</span> UnwrapRef&lt;S&gt;)</span><br><span class="line">   subscriptionMutation = &#123;</span><br><span class="line">     <span class="keyword">type</span>: MutationType.patchFunction,  <span class="comment">// type类型</span></span><br><span class="line">     storeId: $id,</span><br><span class="line">     events: debuggerEvents <span class="keyword">as</span> DebuggerEvent[],</span><br><span class="line">   &#125;</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="comment">// $patch传递对象走合并流程</span></span><br><span class="line">   mergeReactiveObjects(pinia.state.value[$id], partialStateOrMutator)</span><br><span class="line">   subscriptionMutation = &#123;</span><br><span class="line">     <span class="keyword">type</span>: MutationType.patchObject, <span class="comment">// type类型</span></span><br><span class="line">     payload: partialStateOrMutator,</span><br><span class="line">     storeId: $id,</span><br><span class="line">     events: debuggerEvents <span class="keyword">as</span> DebuggerEvent[],</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">const</span> myListenerId = (activeListener = Symbol())</span><br><span class="line"> <span class="comment">// 对于异步修改情况，异步还原isListening,让$subscribe不会监听通过$patch修改state</span></span><br><span class="line"> nextTick().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (activeListener === myListenerId) &#123;</span><br><span class="line">     isListening = <span class="literal">true</span></span><br><span class="line">   &#125;</span><br><span class="line"> &#125;)</span><br><span class="line"> isSyncListening = <span class="literal">true</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">// 手动触发订阅,实现通过$patch批量修改state只触发一次订阅回调</span></span><br><span class="line"> triggerSubscriptions(</span><br><span class="line">   subscriptions,</span><br><span class="line">   subscriptionMutation,</span><br><span class="line">   pinia.state.value[$id] <span class="keyword">as</span> UnwrapRef&lt;S&gt;</span><br><span class="line"> )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 整个store创建结束后将两个监听标识为true,意味着store创建完成,可以进行监听订阅操作</span></span><br><span class="line">isListening = <span class="literal">true</span></span><br><span class="line">isSyncListening = <span class="literal">true</span></span><br><span class="line"><span class="keyword">return</span> store</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="store-API"><a href="#store-API" class="headerlink" title="store API"></a>store API</h2><ul>
<li><h2 id="reset"><a href="#reset" class="headerlink" title="$reset"></a>$reset</h2></li>
</ul>
<p>对于options store提供的还原初始状态的API</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// options store</span></span><br><span class="line">store.$reset = <span class="function"><span class="keyword">function</span> <span class="title">$reset</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> newState = state ? state() : &#123;&#125;  <span class="comment">// state为options中的state</span></span><br><span class="line">  <span class="comment">// 通过$patch批量修改</span></span><br><span class="line">  <span class="keyword">this</span>.$patch(<span class="function">(<span class="params">$state</span>) =&gt;</span> &#123;</span><br><span class="line">    assign($state, newState)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// setup store</span></span><br><span class="line"><span class="keyword">const</span> $reset = __DEV__ <span class="comment">// 开发环境下会报错</span></span><br><span class="line">  ? <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">`🍍: Store "<span class="subst">$&#123;$id&#125;</span>" is built using the setup syntax and does not implement $reset().`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  : noop</span><br></pre></td></tr></table></figure>

<ul>
<li><h2 id="dispose"><a href="#dispose" class="headerlink" title="$dispose"></a>$dispose</h2></li>
</ul>
<p>卸载store的API</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 卸载store</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">$dispose</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  scope.stop() <span class="comment">//卸载store的scope effect</span></span><br><span class="line">  subscriptions = []</span><br><span class="line">  actionSubscriptions = []</span><br><span class="line">  pinia._s.delete($id) <span class="comment">// 从pinia上删除掉对应的store</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="storeToRefs解构store"><a href="#storeToRefs解构store" class="headerlink" title="storeToRefs解构store"></a>storeToRefs解构store</h2><p>通过storeToRefs使得解构store也不会丢失响应式</p>
<ul>
<li>基本使用</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> defineComponent(&#123;</span><br><span class="line">  setup() &#123;</span><br><span class="line">    <span class="keyword">const</span> store = useCounterStore()</span><br><span class="line">    <span class="comment">// ❌ 这将无法生效，因为它破坏了响应性</span></span><br><span class="line">    <span class="comment">// 这与从 `props` 中解构是一样的。</span></span><br><span class="line">    <span class="keyword">const</span> &#123; name, doubleCount &#125; = store</span><br><span class="line"></span><br><span class="line">    name <span class="comment">// "eduardo"</span></span><br><span class="line">    doubleCount <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// 始终是 "eduardo"</span></span><br><span class="line">      name,</span><br><span class="line">      <span class="comment">// 始终是 2</span></span><br><span class="line">      doubleCount,</span><br><span class="line">      <span class="comment">// 这个将是响应式的</span></span><br><span class="line">      doubleValue: computed(<span class="function"><span class="params">()</span> =&gt;</span> store.doubleCount),</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过storeToRefs调用</span></span><br><span class="line"><span class="keyword">import</span> &#123; storeToRefs &#125; <span class="keyword">from</span> <span class="string">'pinia'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> defineComponent(&#123;</span><br><span class="line">  setup() &#123;</span><br><span class="line">    <span class="keyword">const</span> store = useCounterStore()</span><br><span class="line">    <span class="comment">// `name` and `doubleCount` 都是响应式 refs</span></span><br><span class="line">    <span class="comment">// 这也将为由插件添加的属性创建 refs</span></span><br><span class="line">    <span class="comment">// 同时会跳过任何 action 或非响应式(非 ref/响应式)属性</span></span><br><span class="line">    <span class="keyword">const</span> &#123; name, doubleCount &#125; = storeToRefs(store)</span><br><span class="line">    <span class="comment">// 名为 increment 的 action 可以直接提取</span></span><br><span class="line">    <span class="keyword">const</span> &#123; increment &#125; = store</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      name,</span><br><span class="line">      doubleCount,</span><br><span class="line">      increment,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>storeToRefs<ul>
<li>类似toRefs，但会跳过方法和非响应式属性</li>
</ul>
</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// storeToRefs.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">storeToRefs</span>&lt;<span class="title">SS</span> <span class="title">extends</span> <span class="title">StoreGeneric</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  store: SS</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">ToRefs</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">StoreState</span>&lt;<span class="title">SS</span>&gt; &amp; <span class="title">StoreGetters</span>&lt;<span class="title">SS</span>&gt; &amp; <span class="title">PiniaCustomStateProperties</span>&lt;<span class="title">StoreState</span>&lt;<span class="title">SS</span>&gt;&gt;</span></span><br><span class="line"><span class="function">&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isVue2) &#123;</span><br><span class="line">    <span class="comment">// @ts-expect-error: toRefs include methods and others</span></span><br><span class="line">    <span class="keyword">return</span> toRefs(store) <span class="comment">// vue2 版本直接all in ref</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  </span><br><span class="line">    store = toRaw(store) <span class="comment">// 拿到store原始对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> refs = &#123;&#125; <span class="keyword">as</span> ToRefs&lt;</span><br><span class="line">      StoreState&lt;SS&gt; &amp;</span><br><span class="line">        StoreGetters&lt;SS&gt; &amp;</span><br><span class="line">        PiniaCustomStateProperties&lt;StoreState&lt;SS&gt;&gt;</span><br><span class="line">    &gt;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> store) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = store[key]</span><br><span class="line">      <span class="comment">// 只转换ref、reactive属性</span></span><br><span class="line">      <span class="keyword">if</span> (isRef(value) || isReactive(value)) &#123;</span><br><span class="line">        <span class="comment">// @ts-expect-error: the key is state or getter</span></span><br><span class="line">        refs[key] =</span><br><span class="line">          <span class="comment">// ---</span></span><br><span class="line">          toRef(store, key)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> refs</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="map系列辅助函数"><a href="#map系列辅助函数" class="headerlink" title="map系列辅助函数"></a>map系列辅助函数</h2><ul>
<li><h2 id="mapState"><a href="#mapState" class="headerlink" title="mapState"></a>mapState</h2></li>
</ul>
<p>基本使用</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  computed: &#123;</span><br><span class="line">    <span class="comment">// 可以访问组件中的 this.count</span></span><br><span class="line">    <span class="comment">// 与从 store.count 中读取的数据相同</span></span><br><span class="line">    ...mapState(useCounterStore, [<span class="string">'count'</span>])</span><br><span class="line">    <span class="comment">// 与上述相同，但将其注册为 this.myOwnName</span></span><br><span class="line">    ...mapState(useCounterStore, &#123;</span><br><span class="line">      myOwnName: <span class="string">'count'</span>,</span><br><span class="line">      <span class="comment">// 你也可以写一个函数来获得对 store 的访问权</span></span><br><span class="line">      double: <span class="function"><span class="params">store</span> =&gt;</span> store.count * <span class="number">2</span>,</span><br><span class="line">      <span class="comment">// 它可以访问 `this`，但它没有标注类型...</span></span><br><span class="line">      magicValue(store) &#123;</span><br><span class="line">        <span class="keyword">return</span> store.someGetter + <span class="keyword">this</span>.count + <span class="keyword">this</span>.double</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mapState</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mapHelpers.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mapState</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">Id</span> <span class="title">extends</span> <span class="title">string</span>,</span></span><br><span class="line"><span class="function">  <span class="title">S</span> <span class="title">extends</span> <span class="title">StateTree</span>,</span></span><br><span class="line"><span class="function">  <span class="title">G</span> <span class="title">extends</span> <span class="title">_GettersTree</span>&lt;<span class="title">S</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">A</span></span></span><br><span class="line"><span class="function">&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  useStore: StoreDefinition&lt;Id, S, G, A&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  keysOrMapper: <span class="built_in">any</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">_MapStateReturn</span>&lt;<span class="title">S</span>, <span class="title">G</span>&gt; | <span class="title">_MapStateObjectReturn</span>&lt;<span class="title">Id</span>, <span class="title">S</span>, <span class="title">G</span>, <span class="title">A</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 返回一个对象使得能够放到组件的computed属性上</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Array</span>.isArray(keysOrMapper)</span><br><span class="line">    ? keysOrMapper.reduce(<span class="function">(<span class="params">reduced, key</span>) =&gt;</span> &#123;</span><br><span class="line">        reduced[key] = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="keyword">this</span>: ComponentPublicInstance</span>) </span>&#123;</span><br><span class="line">          <span class="comment">// 通过useStore，因为store已经创建，所以内部会直接通过pinia._s.get(id)直接返回store而不会重新创建</span></span><br><span class="line">          <span class="keyword">return</span> useStore(<span class="keyword">this</span>.$pinia)[key]</span><br><span class="line">        &#125; <span class="keyword">as</span> () =&gt; <span class="built_in">any</span></span><br><span class="line">        <span class="keyword">return</span> reduced</span><br><span class="line">      &#125;, &#123;&#125; <span class="keyword">as</span> _MapStateReturn&lt;S, G&gt;)</span><br><span class="line">    : <span class="built_in">Object</span>.keys(keysOrMapper).reduce(<span class="function">(<span class="params">reduced, key: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// @ts-expect-error</span></span><br><span class="line">        reduced[key] = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="keyword">this</span>: ComponentPublicInstance</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">const</span> store = useStore(<span class="keyword">this</span>.$pinia)</span><br><span class="line">          <span class="keyword">const</span> storeKey = keysOrMapper[key]</span><br><span class="line">          <span class="comment">// for some reason TS is unable to infer the type of storeKey to be a</span></span><br><span class="line">          <span class="comment">// function</span></span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">typeof</span> storeKey === <span class="string">'function'</span></span><br><span class="line">            ? <span class="function">(<span class="params">storeKey <span class="keyword">as</span> (<span class="params">store: Store&lt;Id, S, G, A&gt;</span>) =&gt; <span class="built_in">any</span></span>).<span class="params">call</span>(<span class="params"><span class="keyword">this</span>, store</span>)</span></span><br><span class="line"><span class="function">            : <span class="params">store</span>[<span class="params">storeKey</span>]</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">        <span class="params">return</span> <span class="params">reduced</span></span></span><br><span class="line"><span class="function">      &#125;, &#123;&#125; <span class="params">as</span> _<span class="params">MapStateObjectReturn</span>&lt;<span class="params">Id</span>, <span class="params">S</span>, <span class="params">G</span>, <span class="params">A</span>&gt;)</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h2 id="mapGetters"><a href="#mapGetters" class="headerlink" title="mapGetters"></a>mapGetters</h2></li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mapGetters = mapState <span class="comment">//👍</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h2 id="mapActions"><a href="#mapActions" class="headerlink" title="mapActions"></a>mapActions</h2></li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mapActions</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">Id</span> <span class="title">extends</span> <span class="title">string</span>,</span></span><br><span class="line"><span class="function">  <span class="title">S</span> <span class="title">extends</span> <span class="title">StateTree</span>,</span></span><br><span class="line"><span class="function">  <span class="title">G</span> <span class="title">extends</span> <span class="title">_GettersTree</span>&lt;<span class="title">S</span>&gt;,</span></span><br><span class="line"><span class="function">  <span class="title">A</span>,</span></span><br><span class="line"><span class="function">  <span class="title">KeyMapper</span> <span class="title">extends</span> <span class="title">Record</span>&lt;<span class="title">string</span>, <span class="title">keyof</span> <span class="title">A</span>&gt;</span></span><br><span class="line"><span class="function">&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  useStore: StoreDefinition&lt;Id, S, G, A&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  keysOrMapper: <span class="built_in">Array</span>&lt;keyof A&gt; | KeyMapper</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">_MapActionsReturn</span>&lt;<span class="title">A</span>&gt; | <span class="title">_MapActionsObjectReturn</span>&lt;<span class="title">A</span>, <span class="title">KeyMapper</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Array</span>.isArray(keysOrMapper)</span><br><span class="line">    ? keysOrMapper.reduce(<span class="function">(<span class="params">reduced, key</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 和mapState类似,闭包存了下this和其他参数</span></span><br><span class="line">        reduced[key] = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">this</span>: ComponentPublicInstance,</span></span></span><br><span class="line"><span class="function"><span class="params">          ...args: <span class="built_in">any</span>[]</span></span></span><br><span class="line"><span class="function"><span class="params">        </span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> useStore(<span class="keyword">this</span>.$pinia)[key](...args)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> reduced</span><br><span class="line">      &#125;, &#123;&#125; <span class="keyword">as</span> _MapActionsReturn&lt;A&gt;)</span><br><span class="line">    : <span class="built_in">Object</span>.keys(keysOrMapper).reduce(<span class="function">(<span class="params">reduced, key: keyof KeyMapper</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// @ts-expect-error</span></span><br><span class="line">        reduced[key] = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">this</span>: ComponentPublicInstance,</span></span></span><br><span class="line"><span class="function"><span class="params">          ...args: <span class="built_in">any</span>[]</span></span></span><br><span class="line"><span class="function"><span class="params">        </span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> useStore(<span class="keyword">this</span>.$pinia)[keysOrMapper[key]](...args)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> reduced</span><br><span class="line">      &#125;, &#123;&#125; <span class="keyword">as</span> _MapActionsObjectReturn&lt;A, KeyMapper&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="和vuex区别"><a href="#和vuex区别" class="headerlink" title="和vuex区别"></a>和vuex区别</h2><ul>
<li><h2 id="不再有嵌套结构的模块"><a href="#不再有嵌套结构的模块" class="headerlink" title="不再有嵌套结构的模块"></a>不再有嵌套结构的模块</h2><ul>
<li>看过vuex的应该知道，整个vuex就是个嵌套的大对象，会根据命名空间一步一步从对象中取出内容，不过内部会帮你拼接命名空间路径，实际调用时也还好</li>
<li>而pinia不再通过命名空间来嵌套对象，通过pinia._s这个Map结构来存储创建的store，通过pinia.state.value[storeId]来存储state，整个就是一平级的结构</li>
</ul>
</li>
<li><h2 id="创建非常方便，和写一个hook函数一样轻松"><a href="#创建非常方便，和写一个hook函数一样轻松" class="headerlink" title="创建非常方便，和写一个hook函数一样轻松"></a>创建非常方便，和写一个hook函数一样轻松</h2><ul>
<li>虽然但是，总觉得vue越来越像React，用过hox的应该知道，Pinia的使用方式几乎和hox一模一样。。。</li>
</ul>
</li>
<li><h2 id="无需mutation"><a href="#无需mutation" class="headerlink" title="无需mutation"></a>无需mutation</h2><ul>
<li>见仁见智吧，有个mutation调用流程更规范，没有就是函数调用，无学习成本</li>
</ul>
</li>
<li><p>总结一下，虽然单项数据流类型的状态管理库（redux、vuex）具有十分严谨的调用步骤，但这种函数式的方式才是未来（主要是开发爽了。。。）</p>
</li>
</ul>

        </div>

        


        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue/">Vue</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://summxu.github.io/2023/Pinia使用和源码解析/&title=《Pinia使用和源码解析》 — 小兵旭旭的博客&pic=https://summxu.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://summxu.github.io/2023/Pinia使用和源码解析/&title=《Pinia使用和源码解析》 — 小兵旭旭的博客&source=小兵旭旭" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://summxu.github.io/2023/Pinia使用和源码解析/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Pinia使用和源码解析》 — 小兵旭旭的博客&url=https://summxu.github.io/2023/Pinia使用和源码解析/&via=https://summxu.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://summxu.github.io/2023/Pinia使用和源码解析/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2023/现代CSS解决方案：原生支持的三角函数/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">现代CSS解决方案：原生支持的三角函数</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2023/Vue3响应式属性Reactive和Ref/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Vue3响应式属性Reactive和Ref</h4>
      </a>
    </div>
  
</nav>



    




















</article>



</div>

        <footer class="footer">
  <div class="top" style="display: none;">
    
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


    <p>
      <!-- 
      <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i
            class="icon icon-lg icon-rss"></i></a></span>
       -->
      <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
    </p>
  </div>
  <div class="bottom">
    <p><span>summxu &copy;
        2017 -
        2023</span>
      <span>
        
        Power by Hexo
      </span>
    </p>
  </div>
</footer>
    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://summxu.github.io/2023/Pinia使用和源码解析/&title=《Pinia使用和源码解析》 — 小兵旭旭的博客&pic=https://summxu.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://summxu.github.io/2023/Pinia使用和源码解析/&title=《Pinia使用和源码解析》 — 小兵旭旭的博客&source=小兵旭旭" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://summxu.github.io/2023/Pinia使用和源码解析/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Pinia使用和源码解析》 — 小兵旭旭的博客&url=https://summxu.github.io/2023/Pinia使用和源码解析/&via=https://summxu.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://summxu.github.io/2023/Pinia使用和源码解析/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACJUlEQVR42u3aQY7CMAwF0Ln/pZktEmr5tgGp7stqVDpJX5GMY+fvLx6Pp/F85fXTo/E6W7LKhwcGBsZlGcnyyQLVe85fSv5sGBgY92EcLXl0Tx6C84dL1j28joGBgXH6EPP0MX99GBgYGFXGZEtc3SpjYGBg5OlaMml1hvPX9+G9OAYGxgUZval/8/dX+hsYGBiXYjyKoxegk8d6DAYGBsZuxmSZatD8VKP08E4MDIyljLzc30slzx8rZ7y5goGBsZrRA+TFr6TB2WuIHn4nGBgY6xjnAa4XfKsHKfL7o+8BAwNjNSMPcJMly78Gk2MWGBgYixi9ctikAFd9ZW+KcRgYGKsZ1RStV4ZLZiuE116CiIGBcXFGtbjWSwR7G+O8qYCBgbGbMZl0Hnbzmd+0IjAwMJYyek3EeWuz+hLLPVgMDIxFjHmBbNKwrKae5TNuGBgYKxj5YYtk5Alfdc43wRoDA+MGjF57YNJ0nLQfokIbBgbGIkY+6WiBYok/bzlgYGDcmdGcqBU688SxcGYEAwNjKaNa3O+1E3rJYvQqMTAwbsaoHvDKD2HkiWb+vxgYGLsZk9J/Hlh7SWSh5YCBgbGakY9yW7H4iNUfgCYGAwPjsozeEYpvHMWoUjEwMO7GqLYB8kLbpPRf3spiYGBgFBsJ1QMcvWQUAwMD4/db02pJDgMD4z6MvBnQK+jnhy16wR0DA2M347N5Vy/s9pqXGBgYN2D8A6Jzf61FEfdzAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };

</script>

<script src="/js/main.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.js?v=1.7.2" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</body>
</html>
